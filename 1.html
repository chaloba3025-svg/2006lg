<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kahoot-like — Teacher</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f3f6fb;color:#111;margin:0}
  header{background:#2563eb;color:#fff;padding:12px;text-align:center}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .controls{text-align:center;margin-bottom:14px}
  input,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  button:disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
  .stage{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06);min-height:220px}
  .timer{font-size:22px;font-weight:800;margin-bottom:10px}
  .question{font-size:22px;font-weight:800;margin-bottom:14px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .opt{padding:18px;border-radius:12px;color:#fff;font-weight:800;text-align:center}
  .red{background:#e63946}.blue{background:#2a9df4}.yellow{background:#f4b400;color:#111}.green{background:#2ec4b6}
  .opt.correct{outline:4px solid #10b981}
  .opt.wrong{opacity:.45}
  .card{flex:1;background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}
  .row{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #f1f5f9}
  .hidden{display:none}
</style>
</head>
<body>
<header><h2>Kahoot-like — Teacher</h2></header>
<div class="wrap">
  <div class="controls" id="controlsArea">
    <button id="createRoom">Create Room</button>
    <button id="startBtn" disabled>Start</button>
    <div id="roomInfo" style="margin-top:8px;font-weight:bold"></div>
  </div>

  <div id="stage" class="stage">
    <div id="questionView">
      <div class="timer">⏳ <span id="timeLeft">0</span>s</div>
      <div class="question" id="qText">Chưa có câu hỏi</div>
      <div class="options" id="optionsBox"></div>
      <div id="afterBox" style="margin-top:14px;display:none">
        <button id="showTopBtn">SHOW TOP 20</button>
      </div>
    </div>

    <div id="leaderboardView" class="hidden">
      <h3>Top 20</h3>
      <div id="topList"></div>
      <button id="nextQBtn">Next Question</button>
    </div>
  </div>

  <div class="card" id="playersCard">
    <h4>Players</h4>
    <div id="playersList">-</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
authDomain:"kahoot-like-5251e.firebaseapp.com",
databaseURL:"https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"kahoot-like-5251e",storageBucket:"kahoot-like-5251e.appspot.com",
messagingSenderId:"805207333072",appId:"1:805207333072:web:63d23d41b05fa6bd71e6d5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let roomId=null,currentIndex=-1,countdown=null,playersCache={};
const questions=[
  {text:"90° = ?",options:["π/2","π","2π","π/3"],correct:0,time:15},
  {text:"45° = ?",options:["π/4","π/6","π/3","π/2"],correct:0,time:15},
  {text:"60° = ?",options:["π/3","π/2","2π/3","π/4"],correct:0,time:15}
];

// Gen room ID ngắn (A + số 2 chữ số)
function genRoom(){
  const n=Math.floor(Math.random()*90)+10;
  return "A"+n;
}

// Tạo room
document.getElementById("createRoom").onclick=async()=>{
  roomId=genRoom();
  await db.ref("rooms/"+roomId).set({status:"waiting",players:{},scores:{}});
  document.getElementById("roomInfo").textContent="Room: "+roomId;
  document.getElementById("startBtn").disabled=false;
  db.ref("rooms/"+roomId+"/players").on("value",s=>{
    playersCache=s.val()||{};
    renderPlayersList();
  });
};

// Start
document.getElementById("startBtn").onclick=()=>{currentIndex=0;sendQ();}

// Gửi câu hỏi
async function sendQ(){
  const q=questions[currentIndex];
  // shuffle trước khi gửi
  const indices=[0,1,2,3]; for(let i=indices.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[indices[i],indices[j]]=[indices[j],indices[i]];}
  const shuffled=indices.map(i=>q.options[i]);
  const newCorrect=indices.indexOf(q.correct);
  const qobj={...q,options:shuffled,correct:newCorrect};
  await db.ref("rooms/"+roomId+"/current").set({index:currentIndex,q:qobj,status:"open",startedAt:Date.now(),answers:{}});
  renderQTeacher(qobj);
  startTimer(qobj.time||15);
  db.ref("rooms/"+roomId+"/current/answers").off();
  db.ref("rooms/"+roomId+"/current/answers").on("value",async snap=>{
    const ans=snap.val()||{};if(Object.keys(ans).length>=Object.keys(playersCache).length&&Object.keys(playersCache).length>0){
      clearInterval(countdown);await db.ref("rooms/"+roomId+"/current").update({status:"closed"});score();
    }
  });
}

// render Q
function renderQTeacher(q){
  document.getElementById("qText").textContent=q.text;
  const box=document.getElementById("optionsBox");box.innerHTML="";
  ["red","blue","yellow","green"].forEach((c,i)=>{if(q.options[i]){const d=document.createElement("div");d.className="opt "+c;d.textContent=q.options[i];box.appendChild(d);}});
  document.getElementById("afterBox").style.display="none";
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("questionView").classList.remove("hidden");
}

// timer
function startTimer(sec){clearInterval(countdown);let t=sec;document.getElementById("timeLeft").textContent=t;
countdown=setInterval(async()=>{t--;document.getElementById("timeLeft").textContent=t;if(t<=0){clearInterval(countdown);await db.ref("rooms/"+roomId+"/current").update({status:"closed"});score();}},1000);}

// score
async function score(){
  const cur=(await db.ref("rooms/"+roomId+"/current").get()).val();if(!cur)return;
  const ans=(await db.ref("rooms/"+roomId+"/current/answers").get()).val()||{};
  let scores=(await db.ref("rooms/"+roomId+"/scores").get()).val()||{};
  let correctList=[];for(const pid in ans){if(ans[pid].answer==cur.q.correct){correctList.push({pid,time:ans[pid].time});}}
  correctList.sort((a,b)=>a.time-b.time);
  correctList.forEach((e,i)=>{let g=0;if(i==0)g=1000;else if(i==1)g=800;else if(i==2)g=600;else g=400;scores[e.pid]=(scores[e.pid]||0)+g;});
  await db.ref("rooms/"+roomId+"/scores").set(scores);
  await db.ref("rooms/"+roomId+"/ranking").set(Object.keys(scores).map(pid=>({pid,name:playersCache[pid]?.name||pid,score:scores[pid]})).sort((a,b)=>b.score-a.score).slice(0,20));
  highlightCorrect(cur.q);
  document.getElementById("afterBox").style.display="block";
}

// highlight
function highlightCorrect(q){
  const opts=document.querySelectorAll("#optionsBox .opt");
  opts.forEach((el,i)=>{el.classList.remove("correct","wrong");if(i==q.correct)el.classList.add("correct");else el.classList.add("wrong");});
}

// Show top
document.getElementById("showTopBtn").onclick=()=>showLeaderboard();
function showLeaderboard(){
  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.remove("hidden");
  db.ref("rooms/"+roomId+"/ranking").once("value").then(snap=>{
    const arr=snap.val()||[];const el=document.getElementById("topList");el.innerHTML="";arr.forEach((r,i)=>{el.innerHTML+=`<div class="row">${i+1}. ${r.name} <b>${r.score}</b></div>`;});
  });
}
document.getElementById("nextQBtn").onclick=()=>{currentIndex++;if(currentIndex>=questions.length){alert("Hết câu hỏi");return;}sendQ();}
function renderPlayersList(){const el=document.getElementById("playersList");el.innerHTML="";const players=playersCache||{};const keys=Object.keys(players);if(keys.length===0){el.innerHTML="<div class='small'>Chưa có người chơi</div>";return;}keys.forEach(pid=>{const name=players[pid].name||pid;el.innerHTML+=`<div class="row">${name}</div>`;});}
</script>
</body>
</html>
