<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz — Teacher</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:12px}
  .top{display:flex;gap:12px;align-items:center}
  #roomCode{font-weight:700;font-size:20px}
  #players{margin-top:12px}
  .player{padding:6px;border:1px solid #ddd;border-radius:6px;margin:4px 0;display:flex;justify-content:space-between}
  #questionBox{border:1px solid #ccc;padding:12px;margin-top:12px;border-radius:8px;min-height:120px}
  .options{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .option{padding:10px;border-radius:8px;flex:1;min-width:120px;text-align:center;border:1px solid #aaa;cursor:default}
  #topList{margin-top:12px}
  button{padding:8px 12px;border-radius:8px;border:1px solid #888;cursor:pointer}
  #timer{font-weight:700}
</style>
</head>
<body>
<h2>Teacher panel</h2>
<div class="top">
  <div>
    <label>Class name / room prefix: <input id="className" value="A1" /></label>
  </div>
  <div>
    <button id="createRoom">Create Room</button>
  </div>
  <div id="roomInfo" style="display:none">
    Room: <span id="roomCode"></span> (share this to students)
  </div>
</div>

<div id="players"></div>

<div style="margin-top:12px">
  <button id="startQuiz" disabled>Start Quiz</button>
  <button id="nextQuestion" disabled>Next Question</button>
</div>

<div id="questionBox" style="display:none">
  <div>Question <span id="qIndex"></span> / <span id="qTotal"></span></div>
  <div id="qText" style="margin-top:8px;font-size:18px"></div>
  <div id="timer" style="margin-top:8px">Time: <span id="timeLeft">0</span>s</div>
  <div class="options" id="teacherOptions"></div>
</div>

<div id="topList"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
  authDomain: "kahoot-like-5251e.firebaseapp.com",
  projectId: "kahoot-like-5251e",
  storageBucket: "kahoot-like-5251e.firebasestorage.app",
  messagingSenderId: "805207333072",
  appId: "1:805207333072:web:63d23d41b05fa6bd71e6d5",
  measurementId: "G-R81TFGX355"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* State */
let roomId = null;
let questions = [];
let currentIndex = -1;
let countdownTimer = null;

/* 28 câu hỏi gộp sẵn */
const embeddedQuestions = {
  "1": {"correct":0,"level":"easy","options":["π/2","π","2π","π/3"],"text":"Đổi 90° sang radian là:","time":30},
  "2": {"correct":0,"level":"easy","options":["π/4","π/6","π/3","π/2"],"text":"Đổi 45° sang radian là:","time":30},
  "3": {"correct":0,"level":"easy","options":["2π/3","π/3","π/6","π/2"],"text":"Đổi 120° sang radian là:","time":30},
  "4": {"correct":0,"level":"easy","options":["π/3","π/2","2π/3","π/4"],"text":"Đổi 60° sang radian là:","time":30},
  "5": {"correct":0,"level":"easy","options":["3π/2","2π","π","π/2"],"text":"Đổi 270° sang radian là:","time":30},
  "6": {"correct":0,"level":"hard","options":["7π/4","5π/6","11π/6","4π/3"],"text":"Góc 315° bằng bao nhiêu radian?","time":90},
  "7": {"type":"fill","answer":"7π/6","level":"hard","text":"Điền: 210° = ____ rad","sample":"(ví dụ: 7pi/3, căn(2)/2)","time":90},
  "8": {"correct":0,"level":"easy","options":["1/2","√3/2","0","1"],"text":"sin(30°) bằng:","time":30},
  "9": {"correct":0,"level":"easy","options":["1/2","√3/2","0","1"],"text":"cos(60°) bằng:","time":30},
  "10":{"correct":0,"level":"easy","options":["1","0","√3","1/√3"],"text":"tan(45°) bằng:","time":30},
  "11":{"correct":0,"level":"easy","options":["1","0","-1","√3/2"],"text":"cos(0°) bằng:","time":30},
  "12":{"correct":0,"level":"easy","options":["1","0","-1","√2/2"],"text":"sin(90°) bằng:","time":30},
  "13":{"correct":0,"level":"hard","options":["√3","1","0","1/√3"],"text":"Giá trị của tan(60°) là:","time":90},
  "14":{"type":"fill","answer":"√2/2","level":"hard","text":"Điền: cos(45°) = ____","sample":"(ví dụ: 7pi/3, căn(2)/2)","time":90},
  "15":{"correct":0,"level":"easy","options":["6 cm","3 cm","1.5 cm","9 cm"],"text":"Cung 2 rad trên đường tròn bán kính 3 cm có độ dài là:","time":30},
  "16":{"correct":0,"level":"easy","options":["5 cm","10 cm","2 cm","1 cm"],"text":"Cung 1 rad trên đường tròn bán kính 5 cm có độ dài là:","time":30},
  "17":{"correct":0,"level":"easy","options":["6 cm","3 cm","2 cm","1 cm"],"text":"Cung 3 rad trên đường tròn bán kính 2 cm có độ dài là:","time":30},
  "18":{"correct":0,"level":"easy","options":["6 cm","4 cm","3 cm","2 cm"],"text":"Cung 1.5 rad trên đường tròn bán kính 4 cm có độ dài là:","time":30},
  "19":{"correct":0,"level":"easy","options":["5 cm","4 cm","2.5 cm","1 cm"],"text":"Cung 2.5 rad trên đường tròn bán kính 2 cm có độ dài là:","time":30},
  "20":{"correct":0,"level":"hard","options":["28 cm","21 cm","14 cm","7 cm"],"text":"Một đường tròn bán kính 7 cm có cung 4 rad. Tính độ dài cung:","time":90},
  "21":{"type":"fill","answer":"19.2","level":"hard","text":"Điền: Cung 3.2 rad, bán kính 6 cm → độ dài = ____ cm","sample":"(ví dụ: 7pi/3, căn(2)/2)","time":90},
  "22":{"correct":0,"level":"easy","options":["sin","cos","tan","cot"],"text":"sin α = đối / huyền là định nghĩa của:","time":30},
  "23":{"correct":0,"level":"easy","options":["cos","sin","tan","cot"],"text":"cos α = kề / huyền là định nghĩa của:","time":30},
  "24":{"correct":0,"level":"easy","options":["tan","cos","sin","cot"],"text":"tan α = đối / kề là định nghĩa của:","time":30},
  "25":{"correct":0,"level":"easy","options":["cot","sin","cos","tan"],"text":"cot α = kề / đối là định nghĩa của:","time":30},
  "26":{"correct":0,"level":"easy","options":["đối với góc vuông","kề góc vuông","nhỏ nhất","bất kỳ"],"text":"Trong tam giác vuông, cạnh huyền là cạnh:","time":30},
  "27":{"correct":0,"level":"hard","options":["tung độ điểm trên đường tròn","hoành độ điểm","bán kính","diện tích cung"],"text":"Với góc lượng giác α bất kỳ, sinα bằng:","time":90},
  "28":{"type":"fill","answer":"hoành độ","level":"hard","text":"Điền: cosα = ____ của điểm trên đường tròn đơn vị","sample":"(ví dụ: 7pi/3, căn(2)/2)","time":90}
};

/* Convert object -> array */
questions = Object.keys(embeddedQuestions).sort((a,b)=>+a - +b).map(k=>({id:k,...embeddedQuestions[k]}));

/* Helper: room code */
function genRoomCode(){ return Math.floor(100000+Math.random()*900000).toString(); }

/* Create Room */
document.getElementById("createRoom").onclick = async ()=>{
  const prefix = document.getElementById("className").value.trim() || "A1";
  roomId = prefix+"-"+genRoomCode();
  await db.ref("rooms/"+roomId).set({
    teacherCreatedAt:Date.now(),
    status:"waiting",
    players:{},scores:{}
  });
  document.getElementById("roomInfo").style.display="inline";
  document.getElementById("roomCode").textContent=roomId;
  watchPlayers();
};

/* Watch players */
function watchPlayers(){
  db.ref("rooms/"+roomId+"/players").on("value",snap=>{
    const list = document.createElement("div");
    const val = snap.val()||{};
    for(const pid in val){
      const div=document.createElement("div");
      div.className="player";
      div.innerHTML=`<span>${val[pid].name}</span><span>${pid}</span>`;
      list.appendChild(div);
    }
    const playersDiv=document.getElementById("players");
    playersDiv.innerHTML="<h3>Players</h3>";
    playersDiv.appendChild(list);
    document.getElementById("startQuiz").disabled=Object.keys(val).length===0;
  });
}

/* Start quiz */
document.getElementById("startQuiz").onclick=async()=>{
  currentIndex=0;
  showQuestion(currentIndex);
  document.getElementById("nextQuestion").disabled=false;
};

/* Show question */
async function showQuestion(idx){
  const q=questions[idx]; if(!q) return;
  document.getElementById("questionBox").style.display="block";
  document.getElementById("qIndex").textContent=idx+1;
  document.getElementById("qTotal").textContent=questions.length;
  document.getElementById("qText").textContent=q.text;
  const optsDiv=document.getElementById("teacherOptions");
  optsDiv.innerHTML="";
  if(q.type==="fill"){
    optsDiv.textContent="Điền đáp án";
  } else {
    q.options.forEach((o,i)=>{
      const d=document.createElement("div");
      d.className="option"; d.textContent=String.fromCharCode(65+i)+". "+o;
      optsDiv.appendChild(d);
    });
  }
  await db.ref("rooms/"+roomId+"/current").set({
    index:idx,q:q,status:"open",answers:{},startedAt:Date.now()
  });
  startCountdown(q.time||30);
}

/* Next question */
document.getElementById("nextQuestion").onclick=async()=>{
  await db.ref("rooms/"+roomId+"/current").update({status:"closed"});
  currentIndex++;
  if(currentIndex>=questions.length){
    alert("Hết câu hỏi!");
    return;
  }
  showQuestion(currentIndex);
};

/* Countdown */
function startCountdown(sec){
  clearInterval(countdownTimer);
  let left=sec;
  document.getElementById("timeLeft").textContent=left;
  countdownTimer=setInterval(async()=>{
    left--; document.getElementById("timeLeft").textContent=left;
    if(left<=0){
      clearInterval(countdownTimer);
      await db.ref("rooms/"+roomId+"/current").update({status:"closed"});
    }
  },1000);
}
</script>
</body>
</html>
