<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kahoot-like ‚Äî Teacher</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
  header{background:#2563eb;color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:700}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .controls{text-align:center;margin-bottom:14px}
  input,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  button:disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
  .stage{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.08);min-height:220px}
  .timer{font-size:26px;font-weight:800;margin-bottom:10px}
  .question{font-size:24px;font-weight:800;margin-bottom:14px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .opt{padding:18px;border-radius:12px;color:#fff;font-weight:800;text-align:center;transition:all .3s}
  .red{background:#e63946}.blue{background:#2a9df4}.yellow{background:#f4b400;color:#111}.green{background:#2ec4b6}
  .opt.correct{outline:5px solid #10b981}
  .opt.wrong{opacity:.4}
  .card{flex:1;background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(2,6,23,0.06);margin-top:14px}
  .row{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #f1f5f9}
  .hidden{display:none}
  .podium{display:flex;justify-content:center;align-items:flex-end;gap:20px;margin-top:20px}
  .podium div{background:#2563eb;color:#fff;width:120px;text-align:center;border-radius:12px;padding:10px;transition:all .6s}
  .first{height:200px;background:linear-gradient(180deg,#f6c90e,#efb700)}.second{height:160px;background:linear-gradient(180deg,#c0c6cf,#94a3b8)}.third{height:140px;background:linear-gradient(180deg,#d6a160,#f97316)}
  /* leaderboard animation */
  .top-row{transform:translateY(40px);opacity:0;animation:slideIn .5s forwards}
  @keyframes slideIn{to{transform:translateY(0);opacity:1}}
  .score-counter{font-weight:900}
  .gold{background:linear-gradient(180deg,#f6c90e,#efb700);color:#111;padding:8px;border-radius:8px}
  .silver{background:linear-gradient(180deg,#c0c6cf,#94a3b8);color:#111;padding:8px;border-radius:8px}
  .bronze{background:linear-gradient(180deg,#d6a160,#f97316);color:#111;padding:8px;border-radius:8px}
</style>
</head>
<body>
<header>Kahoot-like ‚Äî Teacher</header>
<div class="wrap">
  <div class="controls" id="controlsArea">
    <button id="createRoom">Create Room</button>
    <button id="startBtn" disabled>START</button>
    <div id="roomInfo" style="margin-top:8px;font-weight:bold"></div>
  </div>

  <div id="stage" class="stage">
    <div id="waitingView">‚è≥ Waiting for players...</div>

    <div id="questionView" class="hidden">
      <div class="timer">‚è≥ <span id="timeLeft">0</span>s</div>
      <div class="question" id="qText">C√¢u h·ªèi</div>
      <div class="options" id="optionsBox"></div>
    </div>

    <div id="afterView" class="hidden" style="text-align:center">
      <h3>‚úÖ ƒê√°p √°n ƒë√∫ng ƒë√£ hi·ªÉn th·ªã</h3>
      <button id="showTopBtn">Xem b·∫£ng x·∫øp h·∫°ng</button>
    </div>

    <div id="leaderboardView" class="hidden">
      <h3>B·∫£ng x·∫øp h·∫°ng Top 20</h3>
      <div id="topList"></div>
      <button id="nextQBtn">Next Question</button>
    </div>

    <div id="finalView" class="hidden">
      <h2>K·∫øt th√∫c tr√≤ ch∆°i üéâ</h2>
      <div id="finalRank"></div>
      <div class="podium" id="podiumBox"></div>
      <button id="exportBtn">Export CSV</button>
    </div>
  </div>

  <div class="card" id="playersCard">
    <h4>Players</h4>
    <div id="playersList">-</div>
  </div>
</div>

<!-- Sounds & music -->
<audio id="soundStart" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum.ogg"></audio>
<audio id="soundEnd" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="soundTick" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/metal_thud_and_clang.ogg"></audio>
<audio id="bgMusic" src="https://actions.google.com/sounds/v1/ambiences/office.ogg" loop></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
authDomain:"kahoot-like-5251e.firebaseapp.com",
databaseURL:"https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"kahoot-like-5251e",storageBucket:"kahoot-like-5251e.appspot.com",
messagingSenderId:"805207333072",appId:"1:805207333072:web:63d23d41b05fa6bd71e6d5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let roomId=null,currentIndex=-1,countdown=null,playersCache={};

// ===== 28 c√¢u h·ªèi (gi·ªØ n·ªôi dung) =====
// L∆ØU √ù: ch·ªâ s·ª≠a type cho 7,14,21,28 -> type:'input' v√† provide correctText (chu·ªói ki·ªÉm tra)
// Hi·ªÉn th·ªã c√¢u/ ph∆∞∆°ng √°n gi·ªØ k√Ω hi·ªáu œÄ v√† ‚àö (pi/can(2) √°p d·ª•ng khi h·ªçc sinh nh·∫≠p)
const questions=[
{text:"90¬∞ = ?",options:["œÄ/2","œÄ","2œÄ","œÄ/3"],correct:0,time:30},
{text:"45¬∞ = ?",options:["œÄ/4","œÄ/6","œÄ/3","œÄ/2"],correct:0,time:30},
{text:"60¬∞ = ?",options:["œÄ/3","œÄ/2","2œÄ/3","œÄ/4"],correct:0,time:30},
{text:"180¬∞ = ?",options:["œÄ","œÄ/2","2œÄ","3œÄ/2"],correct:0,time:30},
{text:"270¬∞ = ?",options:["3œÄ/2","œÄ","2œÄ","œÄ/2"],correct:0,time:30},
{text:"360¬∞ = ?",options:["2œÄ","œÄ","œÄ/2","3œÄ/2"],correct:0,time:30},
// 7th -> input
{text:"30¬∞ = ?",type:"input",correctText:"pi/6",time:30},
{text:"120¬∞ = ?",options:["2œÄ/3","œÄ/3","œÄ/2","œÄ"],correct:0,time:30},
{text:"150¬∞ = ?",options:["5œÄ/6","œÄ/2","2œÄ/3","œÄ"],correct:0,time:30},
{text:"210¬∞ = ?",options:["7œÄ/6","œÄ","3œÄ/2","2œÄ"],correct:0,time:30},
{text:"240¬∞ = ?",options:["4œÄ/3","œÄ","œÄ/2","3œÄ/2"],correct:0,time:30},
{text:"300¬∞ = ?",options:["5œÄ/3","œÄ","œÄ/2","2œÄ"],correct:0,time:30},
{text:"330¬∞ = ?",options:["11œÄ/6","œÄ","œÄ/2","2œÄ"],correct:0,time:30},
// 14th -> input (Sinh(0¬∞))
{text:"Sinh(0¬∞) = ?",type:"input",correctText:"0",time:30},
{text:"Cos(0¬∞) = ?",options:["1","0","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Sin(90¬∞) = ?",options:["1","0","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Cos(90¬∞) = ?",options:["0","1","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Sin(180¬∞) = ?",options:["0","1","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Cos(180¬∞) = ?",options:["-1","0","1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Sin(270¬∞) = ?",options:["-1","0","1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
// 21st -> input (Sin(270¬∞))
{text:"Sin(270¬∞) = ?",type:"input",correctText:"-1",time:30},
{text:"Cos(270¬∞) = ?",options:["0","-1","1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Sin(360¬∞) = ?",options:["0","1","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Cos(360¬∞) = ?",options:["1","0","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Tan(45¬∞) = ?",options:["1","0","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Cot(45¬∞) = ?",options:["1","0","-1","Kh√¥ng x√°c ƒë·ªãnh"],correct:0,time:30},
{text:"Tan(0¬∞) = ?",options:["0","1","Kh√¥ng x√°c ƒë·ªãnh","-1"],correct:0,time:30},
{text:"Tan(90¬∞) = ?",options:["Kh√¥ng x√°c ƒë·ªãnh","0","1","-1"],correct:0,time:30},
// 28th -> input (Cot(90¬∞))
{text:"Cot(0¬∞) = ?",options:["Kh√¥ng x√°c ƒë·ªãnh","0","1","-1"],correct:0,time:30},
{text:"Cot(90¬∞) = ?",type:"input",correctText:"khong xac dinh",time:30}
];

// =========== GEN ROOM ===========
function genRoom(){const n=Math.floor(Math.random()*90)+10;return "A"+n;}

document.getElementById("createRoom").onclick=async()=>{
  roomId=genRoom();
  // create room skeleton
  await db.ref("rooms/"+roomId).set({status:"waiting",players:{},scores:{},ranking:[]});
  document.getElementById("roomInfo").textContent="Room: "+roomId;
  document.getElementById("startBtn").disabled=false;
  document.getElementById("waitingView").classList.remove("hidden");
  db.ref("rooms/"+roomId+"/players").on("value",s=>{
    playersCache=s.val()||{};renderPlayersList();
  });
};

function renderPlayersList(){
  let html="";Object.values(playersCache).forEach(p=>{html+="<div>"+p.name+"</div>";});
  document.getElementById("playersList").innerHTML=html||"-";
}

// =========== START GAME ===========
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("playersCard").style.display="none";
  document.getElementById("soundStart").play();
  document.getElementById("bgMusic").play();
  currentIndex=-1;nextQuestion();
  db.ref("rooms/"+roomId).update({status:"playing"});
};

function nextQuestion(){
  currentIndex++;
  if(currentIndex>=questions.length){endGame();return;}
  const q=questions[currentIndex];
  showQuestion(q);
}

function showQuestion(q){
  document.getElementById("waitingView").classList.add("hidden");
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("questionView").classList.remove("hidden");

  document.getElementById("qText").textContent=q.text;
  const box=document.getElementById("optionsBox");box.innerHTML="";
  if(q.type==="input"){
    const input=document.createElement("input");
    input.placeholder="Nh·∫≠p ƒë√°p √°n (vd: pi/6, can(2), 0, -1, khong xac dinh)";
    input.style.width="100%";
    input.id="teacherInputPreview";
    box.appendChild(input);
  } else {
    let opts=[...q.options];
    for(let i=opts.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[opts[i],opts[j]]=[opts[j],opts[i]];}
    const colors=["red","blue","yellow","green"];
    opts.forEach((o,k)=>{
      const d=document.createElement("div");d.className="opt "+colors[k%4];d.textContent=o;box.appendChild(d);
    });
  }

  // set start time so students & teacher can compute speed
  const startAt=Date.now();
  let t=q.time||30;
  updateTime(t);
  db.ref("rooms/"+roomId+"/current").set({q:{text:q.text,options:q.options,type:q.type||'mc',time:q.time,correctIndex:q.correct,correctText:q.correctText||null},status:"open",timeLeft:t,startAt:startAt,answers:{}});

  if(countdown)clearInterval(countdown);
  countdown=setInterval(()=>{
    t--;updateTime(t);
    if(t<=3)document.getElementById("soundTick").play();
    // update timeLeft in db for student displays
    db.ref("rooms/"+roomId+"/current/timeLeft").set(t);
    if(t<=0){clearInterval(countdown);finishQuestion();}
  },1000);
}

function updateTime(t){document.getElementById("timeLeft").textContent=t;}

// =========== FINISH QUESTION ===========
async function finishQuestion(){
  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("afterView").classList.remove("hidden");
  document.getElementById("soundEnd").play();

  // fetch answers and compute scores with time-based bonus
  const ansSnap=await db.ref("rooms/"+roomId+"/current/answers").get();
  const answers=ansSnap.val()||{};
  const q=questions[currentIndex];
  const curSnap=await db.ref("rooms/"+roomId+"/current/startAt").get();
  const startAt=curSnap.val()||Date.now();

  // For each answer compute score: correct -> base + bonus ; wrong -> 0
  for(const pid in answers){
    const a=answers[pid];
    // compute remaining time at submission
    let timeTakenSec=Math.floor((a.time - startAt)/1000);
    if(timeTakenSec<0)timeTakenSec=0;
    const qTime = q.time || 30;
    let remaining = qTime - timeTakenSec;
    if(remaining<0)remaining=0;
    let scoreToAdd=0;
    // check correctness
    let isCorrect=false;
    if(q.type==="input"){
      // normalize both sides: lower, remove spaces
      const given = (String(a.answer||"")).toLowerCase().trim().replace(/\s+/g,'');
      const expected = String(q.correctText||"").toLowerCase().trim().replace(/\s+/g,'');
      // accept some variants for undefined
      const accepted = [expected];
      if(expected==="khong xac dinh") accepted.push("kh√¥ngx√°cƒë·ªãnh","undefined");
      if(accepted.includes(given)) isCorrect=true;
    } else {
      if(Number(a.answer)===Number(q.correct)) isCorrect=true;
    }

    if(isCorrect){
      const base=500;
      const bonus=Math.round((remaining / qTime) * 500);
      scoreToAdd=base+bonus;
    } else {
      scoreToAdd=0;
    }

    const ref=db.ref("rooms/"+roomId+"/scores/"+pid);
    const snap=await ref.get();const old=snap.val()||0;
    await ref.set(old+scoreToAdd);
  }

  // set current.status closed and publish correct info for students to highlight
  let publish={status:"closed"};
  if(questions[currentIndex].type==="input"){
    publish.correctText=questions[currentIndex].correctText;
  } else {
    publish.correctIndex=questions[currentIndex].correct;
  }
  await db.ref("rooms/"+roomId+"/current").update(publish);
}

// =========== SHOW TOP & NEXT ===========
document.getElementById("showTopBtn").onclick=async()=>{
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.remove("hidden");
  const snap=await db.ref("rooms/"+roomId+"/scores").get();
  const scores=snap.val()||{};
  const arr=Object.entries(scores).map(([pid,sc])=>({pid,name:playersCache[pid]?.name||pid,score:sc}));
  arr.sort((a,b)=>b.score-a.score);
  await db.ref("rooms/"+roomId+"/ranking").set(arr);

  // render top 20 with animation and special styling for top 3
  let html="";
  arr.slice(0,20).forEach((r,i)=>{
    let cls="";
    if(i===0) cls="gold";
    else if(i===1) cls="silver";
    else if(i===2) cls="bronze";
    html+=`<div class="row top-row"><span>${i+1}. ${r.name}</span><span class="score-counter ${cls}" data-score="${r.score}">0</span></div>`;
  });
  document.getElementById("topList").innerHTML=html;

  // counter-up effect
  document.querySelectorAll(".score-counter").forEach(el=>{
    const final = Number(el.getAttribute("data-score")||0);
    let cur=0; const step = Math.max(1, Math.floor(final/30));
    const it = setInterval(()=>{ cur+=step; if(cur>=final){el.textContent=final; clearInterval(it);} else el.textContent=cur; },20);
  });
};

document.getElementById("nextQBtn").onclick=()=>{nextQuestion();};

// =========== END GAME ===========
async function endGame(){
  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("finalView").classList.remove("hidden");

  const snap=await db.ref("rooms/"+roomId+"/scores").get();
  const scores=snap.val()||{};
  const arr=Object.entries(scores).map(([pid,sc])=>({pid,name:playersCache[pid]?.name||pid,score:sc}));
  arr.sort((a,b)=>b.score-a.score);

  let html="";arr.forEach((r,i)=>{html+=`<div class="row"><span>${i+1}. ${r.name}</span><span>${r.score}</span></div>`;});
  document.getElementById("finalRank").innerHTML=html;

  const podium=document.getElementById("podiumBox");podium.innerHTML="";
  if(arr[1])podium.innerHTML+=`<div class="second">${arr[1].name}<br/>${arr[1].score}</div>`;
  if(arr[0])podium.innerHTML+=`<div class="first">${arr[0].name}<br/>${arr[0].score}</div>`;
  if(arr[2])podium.innerHTML+=`<div class="third">${arr[2].name}<br/>${arr[2].score}</div>`;

  // export button handler (kept)
  document.getElementById("exportBtn").onclick=async()=>{
    const s=await db.ref("rooms/"+roomId+"/scores").get();
    const scores2=s.val()||{};
    let csv="Name,Score\n";
    Object.entries(scores2).forEach(([pid,sc])=>{csv+=`${playersCache[pid]?.name||pid},${sc}\n`;});
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="results.csv";a.click();
  };

  // after a short delay, remove room data automatically to keep DB clean
  setTimeout(async()=>{
    try{
      await db.ref("rooms/"+roomId).remove();
      console.log("Room removed:",roomId);
    }catch(e){console.warn("Failed to remove room",e);}
  },5000);

  // stop bg music
  try{document.getElementById("bgMusic").pause();document.getElementById("bgMusic").currentTime=0;}catch(e){}
}
</script>
</body>
</html>
