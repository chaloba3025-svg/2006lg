<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kahoot-like — Teacher</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
  header{background:#2563eb;color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:700}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .controls{text-align:center;margin-bottom:14px}
  input,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  button:disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
  .stage{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.08);min-height:220px}
  .timer{font-size:26px;font-weight:800;margin-bottom:10px}
  .question{font-size:24px;font-weight:800;margin-bottom:14px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .opt{padding:18px;border-radius:12px;color:#fff;font-weight:800;text-align:center;transition:all .3s; user-select:none}
  .red{background:#e63946}.blue{background:#2a9df4}.yellow{background:#f4b400;color:#111}.green{background:#2ec4b6}
  .opt.correct{outline:5px solid #10b981;transform:scale(1.02)}
  .opt.wrong{opacity:.35;filter:grayscale(.6)}
  .card{flex:1;background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(2,6,23,0.06);margin-top:14px}
  .row{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #f1f5f9;align-items:center}
  .hidden{display:none}
  .podium{display:flex;justify-content:center;align-items:flex-end;gap:20px;margin-top:20px}
  .podium div{color:#111;width:120px;text-align:center;border-radius:12px;padding:10px;transition:all .6s}
  .first{height:200px;background:linear-gradient(180deg,#f6c90e,#efb700)}.second{height:160px;background:linear-gradient(180deg,#c0c6cf,#94a3b8)}.third{height:140px;background:linear-gradient(180deg,#d6a160,#f97316)}
  .top-row{transform:translateY(40px);opacity:0;animation:slideIn .45s forwards}
  @keyframes slideIn{to{transform:translateY(0);opacity:1}}
  .score-counter{font-weight:900}
  .name-bold{font-weight:800;font-size:16px}
  .gold{background:linear-gradient(180deg,#f6c90e,#efb700);padding:6px;border-radius:6px}
  .silver{background:linear-gradient(180deg,#c0c6cf,#94a3b8);padding:6px;border-radius:6px}
  .bronze{background:linear-gradient(180deg,#d6a160,#f97316);padding:6px;border-radius:6px}
  .controls small{display:block;margin-top:6px;color:#374151}
</style>
</head>
<body>
<header>Kahoot-like — Teacher</header>
<div class="wrap">
  <div class="controls" id="controlsArea">
    <button id="createRoom">Create Room</button>
    <button id="startBtn" disabled>START</button>
    <div id="roomInfo" style="margin-top:8px;font-weight:bold"></div>
    <small>Ghi chú: "Xem bảng xếp hạng" là tạm thời (Continue để tiếp tục chơi). Nút Kết thúc trò chơi chỉ xuất hiện sau câu cuối.</small>
  </div>

  <div id="stage" class="stage">
    <div id="waitingView">⏳ Waiting for players...</div>

    <div id="questionView" class="hidden">
      <div class="timer">⏳ <span id="timeLeft">0</span>s</div>
      <div class="question" id="qText">Câu hỏi</div>
      <div class="options" id="optionsBox"></div>
    </div>

    <div id="afterView" class="hidden" style="text-align:center">
      <h3>✅ Đã đóng câu</h3>
      <div style="margin-top:8px">
        <button id="showTopBtn">Xem bảng xếp hạng</button>
        <button id="nextQBtn" style="margin-left:8px">Tiếp tục</button>
      </div>
    </div>

    <div id="leaderboardView" class="hidden">
      <h3>Bảng xếp hạng Top 20 (Tạm thời)</h3>
      <div id="topList"></div>
      <div style="margin-top:12px">
        <button id="continueBtn">Continue</button>
        <button id="endGameBtn" style="margin-left:8px" class="hidden">Kết thúc trò chơi</button>
      </div>
    </div>

    <div id="finalView" class="hidden">
      <h2>Kết thúc trò chơi 🎉</h2>
      <div id="finalRank"></div>
      <div class="podium" id="podiumBox"></div>
      <button id="exportBtn" style="margin-top:12px">Export CSV</button>
    </div>
  </div>

  <div class="card" id="playersCard">
    <h4>Players</h4>
    <div id="playersList">-</div>
  </div>
</div>

<!-- Sounds & music -->
<audio id="soundStart" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum.ogg"></audio>
<audio id="soundEnd" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="soundTick" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/metal_thud_and_clang.ogg"></audio>
<audio id="bgMusic" src="https://actions.google.com/sounds/v1/ambiences/office.ogg" loop></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
authDomain:"kahoot-like-5251e.firebaseapp.com",
databaseURL:"https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"kahoot-like-5251e",storageBucket:"kahoot-like-5251e.appspot.com",
messagingSenderId:"805207333072",appId:"1:805207333072:web:63d23d41b05fa6bd71e6d5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let roomId=null,currentIndex=-1,countdown=null,playersCache={}, teacherShuffle=[];

// ===== 28 câu chuẩn hóa từ bộ 1, giữ cấu trúc như bộ 2, dùng ký hiệu "π" =====
const questions=[
  {text:"90° đổi sang radian bằng bao nhiêu?",options:["π/2","π","2π","π/3"],correct:0,time:30}
  {text:"180° = ?",options:["π","π/2","2π","3π/2"],correct:0,time:30}
  {text:"360° = ?",options:["2π","π","π/2","3π/2"],correct:0,time:30}
  {text:"45° = ?",options:["π/4","π/3","π/6","π/2"],correct:0,time:30}
  {text:"30° = ?",options:["π/6","π/3","π/4","π/2"],correct:0,time:30}
  {text:"Radian của 120° là?",options:["2π/3","π/2","π/3","π"],correct:0,time:90}
  {text:"Đổi 225° sang radian (chú ý 3π/2 thì nhập là 3pi/2)",type:"input",correctText:"5pi/4",time:90} //7 input

  {text:"Công thức tính độ dài cung tròn là gì?",options:["l=R·a","l=R/a","l=a/R","l=R+a"],correct:0,time:30}
  {text:"Cho R=2, a=π. Độ dài cung l=?",options:["2π","π","4π","π/2"],correct:0,time:30}
  {text:"Cho l=π, R=1. Số đo cung a=?",options:["π","2π","π/2","1"],correct:0,time:30}
  {text:"Cho R=3, a=π/2. Độ dài cung l=?",options:["3π/2","3π","π/2","6π"],correct:0,time:30}
  {text:"Nếu l=2π, a=π thì R bằng bao nhiêu?",options:["2","1","π","4"],correct:0,time:30}
  {text:"Một bánh xe có bán kính 0,5m quay được góc 4rad. Độ dài cung l mà điểm trên vành bánh xe đi được là?",options:["2m","1m","4m","0,5m"],correct:0,time:90}{text:"Sin(45°) = ?", type:"input", correctText:"√2/2", time:30},{text:"Cos(60°) = ?", options:["1/2","√3/2","0","1"], correct:0, time:30},{text:"Tan(30°) = ?", options:["√3/3","√3","1","0"], correct:0, time:30},{text:"Cot(π/3) = ?", options:["√3/3","√3","1","0"], correct:0, time:30},{text:"Sin(300°) = ?", type:"input", correctText:"−√3/2", time:30},
  {text:"Một vòng tròn có R=7m, cung có số đo 120°. Tính độ dài cung (chú ý 3π/2 thì nhập là 3pi/2)",type:"input",correctText:"14pi/3",time:90} //14 input

  {text:"Cho điểm M(1,0) trên đường tròn đơn vị, góc a tương ứng. cos a = ?",options:["1","0","-1","khong xac dinh"],correct:0,time:30}
  {text:"Cho điểm M(0,1). sin a = ?",options:["1","0","-1","khong xac dinh"],correct:0,time:30}
  {text:"Cho điểm M(-1,0). cos a = ?",options:["-1","0","1","khong xac dinh"],correct:0,time:30}
  {text:"Tan 45° = ?",options:["1","0","-1","khong xac dinh"],correct:0,time:30}
  {text:"Cot 45° = ?",options:["1","0","-1","khong xac dinh"],correct:0,time:30}
  {text:"Cho M(0,-1). sin a = ?",options:["-1","0","1","khong xac dinh"],correct:0,time:90}
  {text:"Tính sin 780° (chú ý 2căn(5)/7 thì nhập là 2can(5)/7)",type:"input",correctText:"can(3)/2",time:90} //21 input

  {text:"Công thức nào đúng?",options:["sin²a+cos²a=1","sin²a−cos²a=1","tan²a+1=cos²a","cot²a+1=tan²a"],correct:0,time:30}
  {text:"Tan a = ?",options:["sin a / cos a","cos a / sin a","1/cos a","1/sin a"],correct:0,time:30}
  {text:"Cot a = ?",options:["cos a / sin a","sin a / cos a","1/tan a","tan a"],correct:0,time:30}
  {text:"Cos(180°−a) = ?",options:["−cos a","cos a","sin a","−sin a"],correct:0,time:30}
  {text:"Sin(180°−a) = ?",options:["sin a","−sin a","cos a","−cos a"],correct:0,time:30}
  {text:"Công thức nào sau đây đúng?",options:["1+tan²a=1/cos²a","1+sin²a=cos²a","1+cot²a=sin²a","cos²a+1=tan²a"],correct:0,time:90}{text:"Sin(180°−a) = ?", options:["sin a","−sin a","cos a","−cos a"], correct:0, time:30},{text:"Cos(180°−a) = ?", options:["−cos a","cos a","sin a","−sin a"], correct:0, time:30},{text:"Sin(90°+a) = ?", options:["cos a","−cos a","sin a","−sin a"], correct:0, time:30},{text:"Cos(90°+a) = ?", options:["−sin a","sin a","cos a","−cos a"], correct:0, time:30},{text:"Tan(180°+a) = ?", options:["tan a","−tan a","cot a","−cot a"], correct:0, time:30},
  {text:"Cho sin a=3/4, 90°<a<180°. Tính tan a (chú ý 2căn(5)/7 thì nhập là 2can(5)/7).",type:"input",correctText:"3can(7)/7",time:90} //28 input
];


// helpers
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function genRoom(){const n=Math.floor(Math.random()*90)+10;return "A"+n;}

// create room
document.getElementById("createRoom").onclick=async()=>{
  roomId=genRoom();
  await db.ref("rooms/"+roomId).set({status:"waiting",players:{},scores:{},ranking:[]});
  document.getElementById("roomInfo").textContent="Room: "+roomId;
  document.getElementById("startBtn").disabled=false;
  document.getElementById("waitingView").classList.remove("hidden");

  // listen players
  db.ref("rooms/"+roomId+"/players").on("value",s=>{
    playersCache = s.val() || {};
    renderPlayersList();
  });

  // auto finish if all answered (NEW)
  db.ref("rooms/"+roomId+"/current/answers").on("value", snap=>{
    const answers = snap.val() || {};
    const playersCount = Object.keys(playersCache).length;
    const answersCount = Object.keys(answers).length;
    if(playersCount > 0 && answersCount >= playersCount){
      // slight debounce to allow final write
      setTimeout(()=>{ finishQuestion(); }, 250);
    }
  });
};

function renderPlayersList(){
  let html=""; Object.values(playersCache).forEach(p=>{ html += "<div>"+p.name+"</div>"; });
  document.getElementById("playersList").innerHTML = html || "-";
}

// start
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("playersCard").style.display="none";
  document.getElementById("soundStart").play();
  try{document.getElementById("bgMusic").play();}catch(e){}
  currentIndex = -1; nextQuestion();
  db.ref("rooms/"+roomId).update({status:"playing"});
};

function nextQuestion(){
  currentIndex++;
  if(currentIndex >= questions.length){ endGame(); return; }
  showQuestion(questions[currentIndex]);
}

function showQuestion(q){
  document.getElementById("waitingView").classList.add("hidden");
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("finalView").classList.add("hidden");
  document.getElementById("questionView").classList.remove("hidden");

  document.getElementById("qText").textContent = q.text;
  const box = document.getElementById("optionsBox"); box.innerHTML = "";

  if(q.type === "input"){
    teacherShuffle = [];
  } else {
    // teacher shuffle for display (NEW)
    const opts = q.options.slice();
    const idxs = opts.map((_,i)=>i);
    shuffleArray(idxs);
    teacherShuffle = idxs.slice(); // local mapping: localIdx -> originalIdx
    const colors = ["red","blue","yellow","green"];
    idxs.forEach((origIdx,k)=>{
      const d = document.createElement("div");
      d.className = "opt " + colors[k%4];
      d.textContent = String.fromCharCode(65+k) + ". " + q.options[origIdx];
      box.appendChild(d);
    });
  }

  // publish question to DB WITHOUT correct info (NEW)
  const startAt = Date.now();
  const publishQ = { text: q.text, options: q.options || null, type: q.type || 'mc', time: q.time || 30, startAt: startAt };
  db.ref("rooms/"+roomId+"/current").set({ q: publishQ, status: "open", timeLeft: q.time || 30, startAt: startAt, answers: {} });

  // teacher countdown and update db timeLeft (NEW)
  let t = q.time || 30;
  updateTime(t);
  if(countdown) clearInterval(countdown);
  countdown = setInterval(()=>{
    t--; updateTime(t);
    db.ref("rooms/"+roomId+"/current/timeLeft").set(t);
    if(t <= 3) document.getElementById("soundTick").play();
    if(t <= 0){ clearInterval(countdown); finishQuestion(); }
  },1000);
}

function updateTime(t){ document.getElementById("timeLeft").textContent = t; }

// finish question: grade and update scores + ranking (NEW)
async function finishQuestion(){
  // guard: if already closed, skip
  const curSnap = await db.ref("rooms/"+roomId+"/current").get();
  const curVal = curSnap.val();
  if(!curVal || curVal.status === "closed") return;

  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("afterView").classList.remove("hidden");
  document.getElementById("soundEnd").play();

  const answersSnap = await db.ref("rooms/"+roomId+"/current/answers").get();
  const answers = answersSnap.val() || {};
  const q = questions[currentIndex];
  const startAt = (curVal.startAt) || Date.now();

  // grade each answer
  for(const pid in answers){
    const a = answers[pid];
    const timeSubmitted = a.time || Date.now();
    let timeTakenSec = Math.floor((timeSubmitted - startAt)/1000);
    if(timeTakenSec < 0) timeTakenSec = 0;
    const qTime = q.time || 30;
    let remaining = qTime - timeTakenSec; if(remaining < 0) remaining = 0;
    let scoreToAdd = 0;
    let isCorrect = false;

    if(q.type === "input"){
      const given = String(a.answer||"").toLowerCase().trim().replace(/\s+/g,'');
      const expected = String(q.correctText||"").toLowerCase().trim().replace(/\s+/g,'');
      const accepted = [expected];
      if(expected === "khong xac dinh") accepted.push("khôngxácđịnh","undefined");
      if(accepted.includes(given)) isCorrect = true;
    } else {
      // student sends original index; compare with q.correct
      if(Number(a.answer) === Number(q.correct)) isCorrect = true;
    }

    if(isCorrect){
      const base = 500;
      const bonus = Math.round((remaining / (q.time||30)) * 500);
      scoreToAdd = base + bonus;
    } else {
      scoreToAdd = 0;
    }

    const ref = db.ref("rooms/"+roomId+"/scores/"+pid);
    const snap = await ref.get(); const old = snap.val() || 0;
    await ref.set(old + scoreToAdd);
  }

  // close question in DB (do NOT publish correct answer) (NEW)
  await db.ref("rooms/"+roomId+"/current").update({ status: "closed" });

  // update ranking node so students can read their rank (NEW)
  const snapScores = await db.ref("rooms/"+roomId+"/scores").get();
  const scores = snapScores.val() || {};
  const arr = Object.entries(scores).map(([pid,sc])=>({ pid, name: playersCache[pid]?.name || pid, score: sc }));
  arr.sort((a,b)=>b.score - a.score);
  await db.ref("rooms/"+roomId+"/ranking").set(arr);


  // show "End game" button only on last question (NEW)
  if(currentIndex >= questions.length - 1){
    document.getElementById("endGameBtn").classList.remove("hidden");
  } else {
    document.getElementById("endGameBtn").classList.add("hidden");
  }
}

// show top (temporary leaderboard)
document.getElementById("showTopBtn").onclick = async ()=>{
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.remove("hidden");

  const snap = await db.ref("rooms/"+roomId+"/scores").get();
  const scores = snap.val() || {};
  const arr = Object.entries(scores).map(([pid,sc])=>({ pid, name: playersCache[pid]?.name || pid, score: sc }));
  arr.sort((a,b)=>b.score - a.score);
  await db.ref("rooms/"+roomId+"/ranking").set(arr);

  let html = "";
  arr.slice(0,20).forEach((r,i)=>{
    const star = i < 5 ? " ⭐" : "";
    let special = "";
    if(i===0) special = 'class="gold"';
    else if(i===1) special = 'class="silver"';
    else if(i===2) special = 'class="bronze"';
    html += `<div class="row top-row"><div><span class="name-bold">${i+1}. ${r.name}${star}</span></div><div class="score-counter" data-score="${r.score}" ${special}>0</div></div>`;
  });
  document.getElementById("topList").innerHTML = html;

  // counter-up
  document.querySelectorAll(".score-counter").forEach(el=>{
    const final = Number(el.getAttribute("data-score")||0);
    let cur = 0; const step = Math.max(1, Math.floor(final/30));
    const it = setInterval(()=>{ cur += step; if(cur >= final){ el.textContent = final; clearInterval(it);} else el.textContent = cur; },20);
  });
};

document.getElementById("nextQBtn").onclick = ()=> { nextQuestion(); };
document.getElementById("continueBtn").onclick = ()=> {
  document.getElementById("leaderboardView").classList.add("hidden");
  // resume to next question (teacher can use Next)
  // nothing else required; teacher can click Tiếp tục (Next Question) shown earlier
  // we also show afterView again if needed
  document.getElementById("afterView").classList.remove("hidden");
};
document.getElementById("endGameBtn").onclick = ()=> { endGame(); };

// export csv
document.getElementById("exportBtn").onclick = async ()=>{
  const s = await db.ref("rooms/"+roomId+"/scores").get();
  const scores = s.val() || {};
  let csv = "Name,Score\n";
  Object.entries(scores).forEach(([pid,sc])=>{ csv += `${playersCache[pid]?.name||pid},${sc}\n`; });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="results.csv"; a.click();
};

// end game
async function endGame(){
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("finalView").classList.remove("hidden");
  const snap = await db.ref("rooms/"+roomId+"/scores").get();
  const scores = snap.val() || {};
  const arr = Object.entries(scores).map(([pid,sc])=>({ pid, name: playersCache[pid]?.name || pid, score: sc }));
  arr.sort((a,b)=>b.score - a.score);

  let html = ""; arr.forEach((r,i)=>{ html += `<div class="row"><span>${i+1}. ${r.name}</span><span>${r.score}</span></div>`; });
  document.getElementById("finalRank").innerHTML = html;

  const podium=document.getElementById("podiumBox"); podium.innerHTML="";
  if(arr[1]) podium.innerHTML+=`<div class="second">${arr[1].name}<br/>${arr[1].score}</div>`;
  if(arr[0]) podium.innerHTML+=`<div class="first">${arr[0].name}<br/>${arr[0].score}</div>`;
  if(arr[2]) podium.innerHTML+=`<div class="third">${arr[2].name}<br/>${arr[2].score}</div>`;

  // remove room after short delay (cleanup)
  setTimeout(async ()=>{ try{ await db.ref("rooms/"+roomId).remove(); console.log("Room removed:", roomId); }catch(e){console.warn(e);} }, 5000);
  try{document.getElementById("bgMusic").pause();document.getElementById("bgMusic").currentTime=0;}catch(e){}
}
</script>
</body>
</html>

