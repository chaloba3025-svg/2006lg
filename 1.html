<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz — Teacher</title>
<style>
  :root{--accent:#2b6cb0;--bg:#f7fafc}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:12px;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:12px auto}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:20px;margin:0;padding:0}
  .controls{display:flex;gap:8px;align-items:center}
  input[type=text]{padding:8px;border-radius:6px;border:1px solid #ccc}
  button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:12px;margin-top:12px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
  #playersList .player{display:flex;justify-content:space-between;padding:6px;border-bottom:1px dashed #eee}
  #questionArea{min-height:180px}
  #qText{font-size:20px;font-weight:600;margin-bottom:8px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .optBtn{background:#eef;padding:12px;border-radius:8px;text-align:center;font-weight:700;cursor:default}
  .timer{font-size:18px;font-weight:700;color:#e53e3e}
  #topList .rank{padding:8px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between}
  .small{font-size:13px;color:#666}
  .bigbtn{background:#0ea5a0}
  .muted{background:#ddd;color:#333}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Quiz — Teacher (Kahoot-like)</h1>
    <div class="controls">
      <label>Room prefix <input id="className" type="text" value="A1"/></label>
      <button id="createRoom">Create Room</button>
      <div id="roomInfo" style="display:inline-block;margin-left:8px"></div>
    </div>
  </header>

  <div class="grid">
    <div>
      <div class="card" id="questionCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Câu <span id="qIndex">-</span> / <span id="qTotal">-</span></div>
            <div id="qText" style="margin-top:6px">Chưa có câu hỏi</div>
            <div class="small" id="qLevel"></div>
          </div>
          <div style="text-align:right">
            <div class="timer">Time: <span id="timeLeft">0</span>s</div>
            <div style="margin-top:8px">
              <button id="startQuiz" class="bigbtn muted" disabled>Start Quiz</button>
              <button id="nextQuestion" class="muted" disabled>Next</button>
            </div>
          </div>
        </div>

        <div id="optionsArea" class="options" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Players</h3>
        <div id="playersList">Chưa có người chơi</div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 style="margin:0 0 8px 0">Top 5</h3>
        <div id="topList">Chưa có điểm</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Last round (deltas)</h3>
        <div id="lastRound">Chưa có vòng nào</div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* Firebase config (cập nhật databaseURL) */
const firebaseConfig = {
  apiKey: "AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
  authDomain: "kahoot-like-5251e.firebaseapp.com",
  databaseURL: "https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kahoot-like-5251e",
  storageBucket: "kahoot-like-5251e.appspot.com",
  messagingSenderId: "805207333072",
  appId: "1:805207333072:web:63d23d41b05fa6bd71e6d5",
  measurementId: "G-R81TFGX355"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* State */
let roomId = null;
let questions = [];
let currentIndex = -1;
let countdown = null;

/* 28 câu (đã gộp sẵn) */
const embeddedQuestions = {
  "1":{"correct":0,"options":["π/2","π","2π","π/3"],"text":"Đổi 90° sang radian là:","time":30,"level":"easy"},
  "2":{"correct":0,"options":["π/4","π/6","π/3","π/2"],"text":"Đổi 45° sang radian là:","time":30,"level":"easy"},
  "3":{"correct":0,"options":["2π/3","π/3","π/6","π/2"],"text":"Đổi 120° sang radian là:","time":30,"level":"easy"},
  "4":{"correct":0,"options":["π/3","π/2","2π/3","π/4"],"text":"Đổi 60° sang radian là:","time":30,"level":"easy"},
  "5":{"correct":0,"options":["3π/2","2π","π","π/2"],"text":"Đổi 270° sang radian là:","time":30,"level":"easy"},
  "6":{"correct":0,"options":["7π/4","5π/6","11π/6","4π/3"],"text":"Góc 315° bằng bao nhiêu radian?","time":90,"level":"hard"},
  "7":{"type":"fill","answer":"7π/6","text":"Điền: 210° = ____ rad","time":90,"level":"hard"},
  "8":{"correct":0,"options":["1/2","√3/2","0","1"],"text":"sin(30°) bằng:","time":30,"level":"easy"},
  "9":{"correct":0,"options":["1/2","√3/2","0","1"],"text":"cos(60°) bằng:","time":30,"level":"easy"},
  "10":{"correct":0,"options":["1","0","√3","1/√3"],"text":"tan(45°) bằng:","time":30,"level":"easy"},
  "11":{"correct":0,"options":["1","0","-1","√3/2"],"text":"cos(0°) bằng:","time":30,"level":"easy"},
  "12":{"correct":0,"options":["1","0","-1","√2/2"],"text":"sin(90°) bằng:","time":30,"level":"easy"},
  "13":{"correct":0,"options":["√3","1","0","1/√3"],"text":"Giá trị của tan(60°) là:","time":90,"level":"hard"},
  "14":{"type":"fill","answer":"√2/2","text":"Điền: cos(45°) = ____","time":90,"level":"hard"},
  "15":{"correct":0,"options":["6 cm","3 cm","1.5 cm","9 cm"],"text":"Cung 2 rad trên đường tròn bán kính 3 cm có độ dài là:","time":30,"level":"easy"},
  "16":{"correct":0,"options":["5 cm","10 cm","2 cm","1 cm"],"text":"Cung 1 rad trên đường tròn bán kính 5 cm có độ dài là:","time":30,"level":"easy"},
  "17":{"correct":0,"options":["6 cm","3 cm","2 cm","1 cm"],"text":"Cung 3 rad trên đường tròn bán kính 2 cm có độ dài là:","time":30,"level":"easy"},
  "18":{"correct":0,"options":["6 cm","4 cm","3 cm","2 cm"],"text":"Cung 1.5 rad trên đường tròn bán kính 4 cm có độ dài là:","time":30,"level":"easy"},
  "19":{"correct":0,"options":["5 cm","4 cm","2.5 cm","1 cm"],"text":"Cung 2.5 rad trên đường tròn bán kính 2 cm có độ dài là:","time":30,"level":"easy"},
  "20":{"correct":0,"options":["28 cm","21 cm","14 cm","7 cm"],"text":"Một đường tròn bán kính 7 cm có cung 4 rad. Tính độ dài cung:","time":90,"level":"hard"},
  "21":{"type":"fill","answer":"19.2","text":"Điền: Cung 3.2 rad, bán kính 6 cm → độ dài = ____ cm","time":90,"level":"hard"},
  "22":{"correct":0,"options":["sin","cos","tan","cot"],"text":"sin α = đối / huyền là định nghĩa của:","time":30,"level":"easy"},
  "23":{"correct":0,"options":["cos","sin","tan","cot"],"text":"cos α = kề / huyền là định nghĩa của:","time":30,"level":"easy"},
  "24":{"correct":0,"options":["tan","cos","sin","cot"],"text":"tan α = đối / kề là định nghĩa của:","time":30,"level":"easy"},
  "25":{"correct":0,"options":["cot","sin","cos","tan"],"text":"cot α = kề / đối là định nghĩa của:","time":30,"level":"easy"},
  "26":{"correct":0,"options":["đối với góc vuông","kề góc vuông","nhỏ nhất","bất kỳ"],"text":"Trong tam giác vuông, cạnh huyền là cạnh:","time":30,"level":"easy"},
  "27":{"correct":0,"options":["tung độ điểm trên đường tròn","hoành độ điểm","bán kính","diện tích cung"],"text":"Với góc lượng giác α bất kỳ, sinα bằng:","time":90,"level":"hard"},
  "28":{"type":"fill","answer":"hoành độ","text":"Điền: cosα = ____ của điểm trên đường tròn đơn vị","time":90,"level":"hard"}
};

/* Convert to array */
questions = Object.keys(embeddedQuestions).sort((a,b)=>+a - +b).map(k=>({id:k,...embeddedQuestions[k]}));
document.getElementById('qTotal').textContent = questions.length;

/* Helpers */
function genRoomCode(){ return Math.floor(100000+Math.random()*900000).toString(); }
function normalizeAnswer(s){
  if(s===undefined||s===null) return '';
  let t = String(s).toLowerCase().replace(/\s+/g,'');
  t = t.replace(/π/g,'pi').replace(/π/g,'pi');
  t = t.replace(/căn/g,'sqrt').replace(/√/g,'sqrt');
  t = t.replace(/−/g,'-');
  return t;
}

/* Create room */
document.getElementById('createRoom').onclick = async ()=>{
  const prefix = (document.getElementById('className').value||'A1').trim();
  roomId = prefix + '-' + genRoomCode();
  await db.ref('rooms/'+roomId).set({
    teacherCreatedAt: Date.now(),
    status: 'waiting',
    players: {},
    scores: {},
    questions: questions
  });
  document.getElementById('roomInfo').innerHTML = `<strong>Room:</strong> <span style="font-size:18px">${roomId}</span>`;
  document.getElementById('startQuiz').disabled = false;
  watchPlayers();
};

/* Watch players & scores */
function watchPlayers(){
  const plDiv = document.getElementById('playersList');
  db.ref('rooms/'+roomId+'/players').on('value', snap=>{
    const data = snap.val()||{};
    plDiv.innerHTML = '';
    for(const pid in data){
      const name = data[pid].name||pid;
      const el = document.createElement('div'); el.className='player';
      el.innerHTML = `<div>${name}</div><div class="small" id="score-${pid}">...</div>`;
      plDiv.appendChild(el);
    }
  });
  // watch scores to update side
  db.ref('rooms/'+roomId+'/scores').on('value',snap=>{
    const scores = snap.val()||{};
    // update players list small score
    for(const pid in scores){
      const el = document.getElementById('score-'+pid);
      if(el) el.textContent = scores[pid] + ' pts';
    }
    updateTopList(scores);
  });
  // watch lastRound for display
  db.ref('rooms/'+roomId+'/lastRound').on('value',snap=>{
    const lr = snap.val();
    if(!lr){ document.getElementById('lastRound').textContent = 'Chưa có vòng nào'; return; }
    const div = document.getElementById('lastRound'); div.innerHTML = '';
    div.innerHTML += `<div class="small">Câu ${(+lr.qIndex)+1} — thay đổi điểm</div>`;
    for(const pid in lr.deltas){
      div.innerHTML += `<div style="display:flex;justify-content:space-between;padding:6px">${pid} <strong>${lr.deltas[pid] > 0 ? '+'+lr.deltas[pid] : lr.deltas[pid]}</strong></div>`;
    }
  });
}

/* Start quiz */
document.getElementById('startQuiz').onclick = async ()=>{
  currentIndex = 0;
  await sendQuestion(currentIndex);
  document.getElementById('nextQuestion').disabled = false;
  document.getElementById('startQuiz').disabled = true;
};

/* Send a question */
async function sendQuestion(idx){
  const q = questions[idx];
  if(!q) return;
  // push current
  await db.ref('rooms/'+roomId+'/current').set({
    index: idx,
    q: q,
    status: 'open',
    startedAt: Date.now(),
    timeLeft: q.time || 30,
    answers: {}
  });
  renderQuestion(q, idx);
  startCountdown(q.time || 30);
}

/* Render q in teacher UI */
function renderQuestion(q, idx){
  document.getElementById('qIndex').textContent = idx+1;
  document.getElementById('qText').textContent = q.text || '';
  document.getElementById('qLevel').textContent = (q.level||'');
  const opts = document.getElementById('optionsArea'); opts.innerHTML = '';
  if(q.type === 'fill'){
    const el = document.createElement('div'); el.textContent = '(Fill-in question)';
    opts.appendChild(el);
  } else {
    (q.options||[]).forEach((o,i)=>{
      const b = document.createElement('div'); b.className='optBtn';
      b.textContent = String.fromCharCode(65+i) + '. ' + o;
      opts.appendChild(b);
    });
  }
}

/* Countdown (teacher updates DB timeLeft for students to see) */
function startCountdown(sec){
  clearInterval(countdown);
  let left = sec;
  document.getElementById('timeLeft').textContent = left;
  countdown = setInterval(async ()=>{
    left--;
    document.getElementById('timeLeft').textContent = left;
    // update DB timeLeft
    await db.ref('rooms/'+roomId+'/current').update({timeLeft: left});
    if(left <= 0){
      clearInterval(countdown);
      // close & score
      await db.ref('rooms/'+roomId+'/current').update({status:'closed'});
      await scoreAnswers();
    }
  },1000);
}

/* Next question (teacher manual) */
document.getElementById('nextQuestion').onclick = async ()=>{
  // close current if open and score
  await db.ref('rooms/'+roomId+'/current').update({status:'closed'});
  await scoreAnswers();
  currentIndex++;
  if(currentIndex >= questions.length){
    alert('Hết bộ câu hỏi');
    return;
  }
  await sendQuestion(currentIndex);
};

/* Scoring logic:
   - Accept answers with ts <= startedAt + timeLimit*1000
   - Normalize fill answers (remove spaces, lowercase, convert pi/căn)
   - Position bonus: 1st +500, 2nd +300, 3rd +300, others +100
   - Time score: scaled 0..400 based on remaining time
   - gained = positionBonus + timeScore
*/
async function scoreAnswers(){
  const curSnap = await db.ref('rooms/'+roomId+'/current').once('value');
  const cur = curSnap.val();
  if(!cur) return;
  const q = cur.q;
  const answersSnap = await db.ref('rooms/'+roomId+'/current/answers').once('value');
  const answers = answersSnap.val() || {};
  const startedAt = cur.startedAt || 0;
  const timeLimit = (q.time||30);

  // build correct list (within time)
  let correctList = [];
  for(const pid in answers){
    const a = answers[pid];
    const ts = a.time || a.ts || a.t || 0;
    if(!ts) continue;
    if(ts > (startedAt + timeLimit*1000)) continue; // after time
    let ok = false;
    if(q.type === 'fill'){
      const student = normalizeAnswer(a.answer);
      const target = normalizeAnswer(q.answer);
      if(student === target) ok = true;
      // try numeric compare if both parseFloat
      else if(!isNaN(parseFloat(student)) && !isNaN(parseFloat(target))){
        if(Math.abs(parseFloat(student) - parseFloat(target)) < 1e-6) ok = true;
      }
    } else {
      // student.answer may be index number or string
      if(String(a.answer) === String(q.correct)) ok = true;
      if(+a.answer === +q.correct) ok = true;
    }
    if(ok) correctList.push({pid: pid, ts: ts});
  }

  // sort by ts
  correctList.sort((A,B)=>A.ts - B.ts);

  // position bonus
  const deltas = {};
  // load previous scores
  const scoresSnap = await db.ref('rooms/'+roomId+'/scores').once('value');
  const scores = scoresSnap.val() || {};

  correctList.forEach((entry,i)=>{
    const pid = entry.pid;
    const ts = entry.ts;
    const timeUsed = Math.max(0, (ts - startedAt)/1000);
    const clamped = Math.min(timeLimit, timeUsed);
    const timeScore = Math.round(400 * Math.max(0, (1 - (clamped / timeLimit)))); // 0..400
    let posBonus = 100;
    if(i===0) posBonus = 500;
    else if(i===1) posBonus = 300;
    else if(i===2) posBonus = 300;
    else posBonus = 100;
    const gained = posBonus + timeScore;
    deltas[pid] = gained;
    scores[pid] = (scores[pid] || 0) + gained;
  });

  // for players who answered but incorrect -> deltas 0 (but we may want to show 0)
  for(const pid in answers){
    if(!deltas[pid]) deltas[pid] = 0;
  }

  // write back scores and lastRound and ranking
  await db.ref('rooms/'+roomId+'/scores').set(scores);
  await db.ref('rooms/'+roomId+'/lastRound').set({ qIndex: cur.index, deltas: deltas, timestamp: Date.now() });

  // compute ranking top N and save
  const arr = Object.keys(scores).map(p=>({pid:p,score:scores[p]})).sort((a,b)=>b.score - a.score);
  const ranking = arr.slice(0,10); // save top 10
  await db.ref('rooms/'+roomId+'/ranking').set(ranking);

  // update teacher display
  updateTopList(scores);
}

/* Update top list in UI */
function updateTopList(scores){
  const arr = Object.keys(scores||{}).map(p=>({pid:p,score:scores[p]})).sort((a,b)=>b.score - a.score);
  const top5 = arr.slice(0,5);
  const el = document.getElementById('topList'); el.innerHTML = '';
  if(top5.length===0){ el.textContent = 'Chưa có điểm'; return; }
  top5.forEach((p,i)=>{
    const div = document.createElement('div'); div.className='rank';
    div.innerHTML = `<div>${i+1}. ${p.pid}</div><div><strong>${p.score}</strong></div>`;
    el.appendChild(div);
  });
}

/* End of script */
</script>
</body>
</html>
