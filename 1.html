<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kahoot-like â€” Teacher</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f3f6fb;color:#111}
  header{background:#2563eb;color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:700}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .controls{text-align:center;margin-bottom:14px}
  input,button{padding:10px;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  button:disabled{background:#cbd5e1;color:#6b7280;cursor:not-allowed}
  .stage{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.08);min-height:220px}
  .timer{font-size:26px;font-weight:800;margin-bottom:10px}
  .question{font-size:24px;font-weight:800;margin-bottom:14px}
  .options{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .opt{padding:18px;border-radius:12px;color:#fff;font-weight:800;text-align:center;transition:all .3s; user-select:none}
  .red{background:#e63946}.blue{background:#2a9df4}.yellow{background:#f4b400;color:#111}.green{background:#2ec4b6}
  .opt.correct{outline:5px solid #10b981;transform:scale(1.02)}
  .opt.wrong{opacity:.35;filter:grayscale(.6)}
  .card{flex:1;background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(2,6,23,0.06);margin-top:14px}
  .row{display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #f1f5f9;align-items:center}
  .hidden{display:none}
  .podium{display:flex;justify-content:center;align-items:flex-end;gap:20px;margin-top:20px}
  .podium div{color:#111;width:120px;text-align:center;border-radius:12px;padding:10px;transition:all .6s}
  .first{height:200px;background:linear-gradient(180deg,#f6c90e,#efb700)}.second{height:160px;background:linear-gradient(180deg,#c0c6cf,#94a3b8)}.third{height:140px;background:linear-gradient(180deg,#d6a160,#f97316)}
  .top-row{transform:translateY(40px);opacity:0;animation:slideIn .45s forwards}
  @keyframes slideIn{to{transform:translateY(0);opacity:1}}
  .score-counter{font-weight:900}
  .name-bold{font-weight:800;font-size:16px}
  .gold{background:linear-gradient(180deg,#f6c90e,#efb700);padding:6px;border-radius:6px}
  .silver{background:linear-gradient(180deg,#c0c6cf,#94a3b8);padding:6px;border-radius:6px}
  .bronze{background:linear-gradient(180deg,#d6a160,#f97316);padding:6px;border-radius:6px}
  .controls small{display:block;margin-top:6px;color:#374151}
</style>
</head>
<body>
<header>Kahoot-like â€” Teacher</header>
<div class="wrap">
  <div class="controls" id="controlsArea">
    <button id="createRoom">Create Room</button>
    <button id="startBtn" disabled>START</button>
    <div id="roomInfo" style="margin-top:8px;font-weight:bold"></div>
    <small>Ghi chÃº: "Xem báº£ng xáº¿p háº¡ng" lÃ  táº¡m thá»i (Continue Ä‘á»ƒ tiáº¿p tá»¥c chÆ¡i). NÃºt Káº¿t thÃºc trÃ² chÆ¡i chá»‰ xuáº¥t hiá»‡n sau cÃ¢u cuá»‘i.</small>
  </div>

  <div id="stage" class="stage">
    <div id="waitingView">â³ Waiting for players...</div>

    <div id="questionView" class="hidden">
      <div class="timer">â³ <span id="timeLeft">0</span>s</div>
      <div class="question" id="qText">CÃ¢u há»i</div>
      <div class="options" id="optionsBox"></div>
    </div>

    <div id="afterView" class="hidden" style="text-align:center">
      <h3>âœ… ÄÃ£ Ä‘Ã³ng cÃ¢u</h3>
      <div style="margin-top:8px">
        <button id="showTopBtn">Xem báº£ng xáº¿p háº¡ng</button>
        <button id="nextQBtn" style="margin-left:8px">Tiáº¿p tá»¥c</button>
      </div>
    </div>

    <div id="leaderboardView" class="hidden">
      <h3>Báº£ng xáº¿p háº¡ng Top 20 (Táº¡m thá»i)</h3>
      <div id="topList"></div>
      <div style="margin-top:12px">
        <button id="continueBtn">Continue</button>
        <button id="endGameBtn" style="margin-left:8px" class="hidden">Káº¿t thÃºc trÃ² chÆ¡i</button>
      </div>
    </div>

    <div id="finalView" class="hidden">
      <h2>Káº¿t thÃºc trÃ² chÆ¡i ğŸ‰</h2>
      <div id="finalRank"></div>
      <div class="podium" id="podiumBox"></div>
      <button id="exportBtn" style="margin-top:12px">Export CSV</button>
    </div>
  </div>

  <div class="card" id="playersCard">
    <h4>Players</h4>
    <div id="playersList">-</div>
  </div>
</div>

<!-- Sounds & music -->
<audio id="soundStart" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum.ogg"></audio>
<audio id="soundEnd" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="soundTick" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/metal_thud_and_clang.ogg"></audio>
<audio id="bgMusic" src="https://actions.google.com/sounds/v1/ambiences/office.ogg" loop></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ==== Firebase init ====
const firebaseConfig={apiKey:"AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
authDomain:"kahoot-like-5251e.firebaseapp.com",
databaseURL:"https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"kahoot-like-5251e",storageBucket:"kahoot-like-5251e.appspot.com",
messagingSenderId:"805207333072",appId:"1:805207333072:web:63d23d41b05fa6bd71e6d5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// ==== Bá»™ cÃ¢u há»i má»›i ====
let allQuestions=[
// Chá»§ Ä‘á» 1
{text:"90Â° Ä‘á»•i sang radian báº±ng bao nhiÃªu?",options:["pi/2","pi","2pi","pi/3"],correct:0,time:30},
{text:"180Â° = ?",options:["pi","pi/2","2pi","3pi/2"],correct:0,time:30},
{text:"360Â° = ?",options:["2pi","pi","pi/2","3pi/2"],correct:0,time:30},
{text:"45Â° = ?",options:["pi/4","pi/3","pi/6","pi/2"],correct:0,time:30},
{text:"30Â° = ?",options:["pi/6","pi/3","pi/4","pi/2"],correct:0,time:30},
{text:"Radian cá»§a 120Â° lÃ ?",options:["2pi/3","pi/2","pi/3","pi"],correct:0,time:90},
{text:"Äá»•i 225Â° sang radian (nháº­p dáº¡ng cÃ³ pi)",type:"input",correctText:"5pi/4",time:90},
// Chá»§ Ä‘á» 2
{text:"CÃ´ng thá»©c tÃ­nh Ä‘á»™ dÃ i cung trÃ²n lÃ  gÃ¬?",options:["l=RÂ·a","l=R/a","l=a/R","l=R+a"],correct:0,time:30},
{text:"Cho R=2, a=pi. Äá»™ dÃ i cung l=?",options:["2pi","pi","4pi","pi/2"],correct:0,time:30},
{text:"Cho l=pi, R=1. Sá»‘ Ä‘o cung a=?",options:["pi","2pi","pi/2","1"],correct:0,time:30},
{text:"Cho R=3, a=pi/2. Äá»™ dÃ i cung l=?",options:["3pi/2","3pi","pi/2","6pi"],correct:0,time:30},
{text:"Náº¿u l=2pi, a=pi thÃ¬ R báº±ng bao nhiÃªu?",options:["2","1","pi","4"],correct:0,time:30},
{text:"Má»™t bÃ¡nh xe cÃ³ bÃ¡n kÃ­nh 0,5m quay Ä‘Æ°á»£c gÃ³c 4rad. Äá»™ dÃ i cung l mÃ  Ä‘iá»ƒm trÃªn vÃ nh bÃ¡nh xe Ä‘i Ä‘Æ°á»£c lÃ ?",options:["2m","1m","4m","0,5m"],correct:0,time:90},
{text:"Má»™t vÃ²ng trÃ²n cÃ³ R=7m, cung cÃ³ sá»‘ Ä‘o 120Â°. TÃ­nh Ä‘á»™ dÃ i cung (nháº­p káº¿t quáº£ dáº¡ng pi)",type:"input",correctText:"14pi/3",time:90},
// Chá»§ Ä‘á» 3
{text:"Cho Ä‘iá»ƒm M(1,0) trÃªn Ä‘Æ°á»ng trÃ²n Ä‘Æ¡n vá»‹, gÃ³c a tÆ°Æ¡ng á»©ng. cos a = ?",options:["1","0","-1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:30},
{text:"Cho Ä‘iá»ƒm M(0,1). sin a = ?",options:["1","0","-1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:30},
{text:"Cho Ä‘iá»ƒm M(-1,0). cos a = ?",options:["-1","0","1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:30},
{text:"Tan 45Â° = ?",options:["1","0","-1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:30},
{text:"Cot 45Â° = ?",options:["1","0","-1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:30},
{text:"Cho M(0,-1). sin a = ?",options:["-1","0","1","KhÃ´ng xÃ¡c Ä‘á»‹nh"],correct:0,time:90},
{text:"TÃ­nh sin 780Â° (nháº­p káº¿t quáº£ dáº¡ng pi hoáº·c can)",type:"input",correctText:"can(3)/2",time:90},
// Chá»§ Ä‘á» 4
{text:"CÃ´ng thá»©c nÃ o Ä‘Ãºng?",options:["sinÂ²a+cosÂ²a=1","sinÂ²aâˆ’cosÂ²a=1","tanÂ²a+1=cosÂ²a","cotÂ²a+1=tanÂ²a"],correct:0,time:30},
{text:"Tan a = ?",options:["sin a / cos a","cos a / sin a","1/cos a","1/sin a"],correct:0,time:30},
{text:"Cot a = ?",options:["cos a / sin a","sin a / cos a","1/tan a","tan a"],correct:0,time:30},
{text:"Cos(180Â°âˆ’a) = ?",options:["âˆ’cos a","cos a","sin a","âˆ’sin a"],correct:0,time:30},
{text:"Sin(180Â°âˆ’a) = ?",options:["sin a","âˆ’sin a","cos a","âˆ’cos a"],correct:0,time:30},
{text:"CÃ´ng thá»©c nÃ o sau Ä‘Ã¢y Ä‘Ãºng?",options:["1+tanÂ²a=1/cosÂ²a","1+sinÂ²a=cosÂ²a","1+cotÂ²a=sinÂ²a","cosÂ²a+1=tanÂ²a"],correct:0,time:90},
{text:"Cho sin a=3/4, 90Â°<a<180Â°. TÃ­nh tan a (nháº­p phÃ¢n sá»‘).",type:"input",correctText:"3/can(7)",time:90},
];
// shuffle MCQ, giá»¯ input táº¡i 7,14,21,28
function shuffleExceptInputs(qs){
  const inputPos={7:qs[6],14:qs[13],21:qs[20],28:qs[27]};
  let mcq=qs.filter((q,i)=>![6,13,20,27].includes(i));
  for(let i=mcq.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [mcq[i],mcq[j]]=[mcq[j],mcq[i]];
  }
  let result=[];let idx=0;
  for(let i=1;i<=28;i++){
    if([7,14,21,28].includes(i)) result.push(inputPos[i]);
    else result.push(mcq[idx++]);
  }
  return result;
}
const questions=shuffleExceptInputs(allQuestions);

// Biáº¿n chung
let roomId=null,currentIndex=-1,countdown=null,playersCache={}, teacherShuffle=[];
</script>
<script>
// ====== Táº¡o phÃ²ng vÃ  quáº£n lÃ½ ngÆ°á»i chÆ¡i ======
document.getElementById("createRoom").onclick=()=>{
  roomId=Math.random().toString(36).substring(2,7).toUpperCase();
  db.ref("rooms/"+roomId).set({status:"waiting",players:{},currentIndex:-1});
  document.getElementById("roomInfo").innerText="Room ID: "+roomId;
  document.getElementById("startBtn").disabled=false;

  // âœ… Láº¯ng nghe danh sÃ¡ch players khi cÃ³ thay Ä‘á»•i
  db.ref("rooms/"+roomId+"/players").on("value", snap=>{
    updatePlayersList(snap.val()||{});
  });
};

db.ref("rooms").on("child_removed",snap=>{
  if(snap.key===roomId){alert("Room closed");location.reload();}
});

// Cáº­p nháº­t danh sÃ¡ch ngÆ°á»i chÆ¡i
function updatePlayersList(players){
  let html="";
  for(let id in players){
    html+=`<div class="row"><span>${players[id].name}</span><span>${players[id].score||0}</span></div>`;
  }
  document.getElementById("playersList").innerHTML=html||"-";
}

</script>
<script>
// ====== Báº¯t Ä‘áº§u game ======
document.getElementById("startBtn").onclick=()=>{
  db.ref("rooms/"+roomId).update({status:"playing"});
  currentIndex=0;
  showQuestion();
  document.getElementById("bgMusic").play();
};

// ====== Hiá»ƒn thá»‹ cÃ¢u há»i ======
function showQuestion(){
  if(currentIndex>=questions.length){
    endGame();
    return;
  }
  let q=questions[currentIndex];
  teacherShuffle=shuffleArray(q.options.map((o,i)=>({text:o,index:i})));

  db.ref("rooms/"+roomId+"/current").set({
  q: q,
  teacherShuffle: teacherShuffle,
  startAt: Date.now(),
  status: "playing"
});

  document.getElementById("waitingView").classList.add("hidden");
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("finalView").classList.add("hidden");
  document.getElementById("questionView").classList.remove("hidden");

  document.getElementById("qText").innerText=q.text;
  let optBox=document.getElementById("optionsBox");
  optBox.innerHTML="";
  if(!q.type){ // multiple choice
    teacherShuffle.forEach((opt,idx)=>{
      let div=document.createElement("div");
      div.className="opt "+["red","blue","yellow","green"][idx];
      div.innerText=opt.text;
      optBox.appendChild(div);
    });
  } else {
    optBox.innerHTML="<em>CÃ¢u há»i Ä‘iá»n vÃ o Ã´ trá»‘ng</em>";
  }

  let time=q.time;
  document.getElementById("timeLeft").innerText=time;
  clearInterval(countdown);
  countdown=setInterval(()=>{
    time--;
    document.getElementById("timeLeft").innerText=time;
    if(time<=0){clearInterval(countdown);finishQuestion();}
  },1000);

  document.getElementById("soundStart").play();
}

// Shuffle máº£ng
function shuffleArray(arr){
  let copy=[...arr];
  for(let i=copy.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [copy[i],copy[j]]=[copy[j],copy[i]];
  }
  return copy;
}
</script>
<script>
function finishQuestion(){
  clearInterval(countdown);
  let q=questions[currentIndex];

  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("afterView").classList.remove("hidden");

    // hiá»ƒn thá»‹ Ä‘Ã¡p Ã¡n Ä‘Ãºng cho giÃ¡o viÃªn
  if(!q.type){
    let opts=document.querySelectorAll(".opt");
    opts.forEach((el,idx)=>{
      let origIdx=teacherShuffle[idx].index;
      if(origIdx===q.correct) el.classList.add("correct");
      else el.classList.add("wrong");
    });
  } else {
    document.getElementById("optionsBox").innerHTML="âœ… ÄÃ¡p Ã¡n Ä‘Ãºng: "+q.correctText;
  }

  document.getElementById("soundEnd").play();

  // ğŸ”¹ cáº­p nháº­t tráº¡ng thÃ¡i sang "closed" Ä‘á»ƒ há»c sinh báº¯t Ä‘Æ°á»£c
  db.ref("rooms/"+roomId+"/current/status").set("closed");
}

// xem báº£ng xáº¿p háº¡ng

document.getElementById("showTopBtn").onclick=()=>{
  showLeaderboard();
};

document.getElementById("nextQBtn").onclick=()=>{
  currentIndex++;
  showQuestion();
};
</script>
<script>
function showLeaderboard(){
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.remove("hidden");

  db.ref("rooms/"+roomId+"/players").once("value",snap=>{
    let players=[];
    snap.forEach(s=>players.push(s.val()));
    players.sort((a,b)=>b.score-a.score);

    let html="";
    players.slice(0,20).forEach((p,i)=>{
      let cls=i==0?"gold":i==1?"silver":i==2?"bronze":"";
      html+=`<div class="row top-row ${cls}">
        <span class="name-bold">${i+1}. ${p.name}</span>
        <span class="score-counter">${p.score}</span>
      </div>`;
    });
    document.getElementById("topList").innerHTML=html;
  });
}

document.getElementById("continueBtn").onclick=()=>{
  document.getElementById("leaderboardView").classList.add("hidden");
  if(currentIndex>=questions.length-1){
    endGame();
  } else {
    currentIndex++;
    showQuestion();
  }
};
</script>
<script>
function endGame(){
  document.getElementById("questionView").classList.add("hidden");
  document.getElementById("afterView").classList.add("hidden");
  document.getElementById("leaderboardView").classList.add("hidden");
  document.getElementById("finalView").classList.remove("hidden");

  db.ref("rooms/"+roomId+"/players").once("value",snap=>{
    let players=[];
    snap.forEach(s=>players.push(s.val()));
    players.sort((a,b)=>b.score-a.score);

    let podium=document.getElementById("podiumBox");
    podium.innerHTML="";
    ["second","first","third"].forEach((pos,idx)=>{
      let p=players[idx];
      if(p){
        let div=document.createElement("div");
        div.className=pos;
        div.innerHTML=`<h3>${idx+1}. ${p.name}</h3><p>${p.score}</p>`;
        podium.appendChild(div);
      }
    });
  });

  db.ref("rooms/"+roomId).remove(); // xÃ³a phÃ²ng
}

document.getElementById("exportBtn").onclick=()=>{
  db.ref("rooms/"+roomId+"/players").once("value",snap=>{
    let csv="Name,Score\n";
    snap.forEach(s=>{let p=s.val();csv+=`${p.name},${p.score}\n`;});
    let blob=new Blob([csv],{type:"text/csv"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="scores.csv";
    a.click();
  });
};
</script>
</body>
</html>
