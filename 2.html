<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz ‚Äî Student</title>
<style>
  :root{--bg:#f8fafc}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:12px;background:var(--bg);color:#111}
  .wrap{max-width:720px;margin:0 auto}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);margin-top:12px}
  input{padding:10px;border-radius:8px;border:1px solid #ccc;width:calc(100% - 24px)}
  button{background:#2b6cb0;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .qText{font-size:22px;font-weight:700;margin-top:8px}
  .opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .optBtn{padding:18px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;color:#fff}
  .c-red{background:#ef4444} .c-blue{background:#3b82f6} .c-yellow{background:#f59e0b;color:#222} .c-green{background:#10b981}
  .timer{font-weight:800;font-size:18px;color:#e53e3e}
  #status{margin-top:10px;font-weight:700}
  .small{font-size:13px;color:#555}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Student</h2>
    <div id="joinArea">
      <input id="nameInput" placeholder="T√™n c·ªßa b·∫°n" /><br/><br/>
      <input id="roomInput" placeholder="M√£ ph√≤ng (v√≠ d·ª• A1-123456)" /><br/><br/>
      <button id="joinBtn">Join Room</button>
    </div>

    <div id="playArea" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="roomLabel"></strong></div>
        <div class="timer">Time: <span id="timeLeft">0</span>s</div>
      </div>

      <div class="qText" id="qText">Ch∆∞a c√≥ c√¢u h·ªèi</div>
      <div class="small" id="qHint"></div>

      <div id="opts" class="opts" style="margin-top:12px"></div>

      <div id="fillArea" style="margin-top:12px;display:none">
        <input id="fillInput" placeholder="Nh·∫≠p ƒë√°p √°n..." />
        <button id="fillSubmit">G·ª≠i</button>
      </div>

      <div id="status" class="small">Tr·∫°ng th√°i: Ch∆∞a v√†o ph√≤ng</div>

      <div class="card" style="margin-top:12px">
        <div><strong>ƒêi·ªÉm c·ªßa b·∫°n:</strong> <span id="myScore">0</span></div>
        <div><strong>H·∫°ng:</strong> <span id="myRank">-</span> <span id="medal"></span></div>
        <div id="top3" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* Firebase config (same as teacher) */
const firebaseConfig = {
  apiKey: "AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
  authDomain: "kahoot-like-5251e.firebaseapp.com",
  databaseURL: "https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kahoot-like-5251e",
  storageBucket: "kahoot-like-5251e.appspot.com",
  messagingSenderId: "805207333072",
  appId: "1:805207333072:web:63d23d41b05fa6bd71e6d5",
  measurementId: "G-R81TFGX355"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomId = null;
let playerId = localStorage.getItem('playerId') || ('p' + Math.floor(Math.random()*1000000));
localStorage.setItem('playerId', playerId);
let playerName = null;
let joined = false;
let currentQIndex = -1;

/* Join */
document.getElementById('joinBtn').onclick = async ()=>{
  const name = (document.getElementById('nameInput').value || '').trim();
  const room = (document.getElementById('roomInput').value || '').trim();
  if(!name || !room){ alert('Nh·∫≠p t√™n v√† m√£ ph√≤ng'); return; }
  playerName = name; roomId = room;
  await db.ref('rooms/'+roomId+'/players/'+playerId).set({name: playerName, joinedAt: Date.now()});
  // ensure scores exist
  const s = await db.ref('rooms/'+roomId+'/scores/'+playerId).once('value');
  if(!s.exists()) await db.ref('rooms/'+roomId+'/scores/'+playerId).set(0);
  document.getElementById('joinArea').style.display = 'none';
  document.getElementById('playArea').style.display = 'block';
  document.getElementById('roomLabel').textContent = roomId;
  document.getElementById('status').textContent = 'ƒê√£ v√†o ph√≤ng. Ch·ªù gi√°o vi√™n ph√°t c√¢u h·ªèi...';
  joined = true;
  listenCurrent();
  listenScoresAndRanking();
};

/* Listen current question */
function listenCurrent(){
  db.ref('rooms/'+roomId+'/current').on('value', snap=>{
    const cur = snap.val();
    if(!cur) return;
    document.getElementById('timeLeft').textContent = cur.timeLeft !== undefined ? cur.timeLeft : (cur.q && cur.q.time ? cur.q.time : 0);
    if(cur.status === 'open'){
      showQuestion(cur);
    } else {
      document.getElementById('status').textContent = 'V√≤ng ƒë√≥ng ‚Äî ch·ªù k·∫øt qu·∫£';
      hideQuestion();
    }
  });
  // listen lastRound to show gained points when teacher finished scoring
  db.ref('rooms/'+roomId+'/lastRound').on('value', snap=>{
    const lr = snap.val();
    if(!lr) return;
    // if lastRound corresponds to the question we saw, show delta
    const delta = (lr.deltas && lr.deltas[playerId]) ? lr.deltas[playerId] : 0;
    if(delta !== undefined){
      document.getElementById('status').textContent = `L∆∞·ª£t v·ª´a r·ªìi: ${delta>0? '+'+delta : delta} ƒëi·ªÉm`;
    }
  });
}

/* Show question */
function showQuestion(cur){
  const q = cur.q;
  currentQIndex = cur.index;
  document.getElementById('qText').textContent = q.text || '';
  document.getElementById('qHint').textContent = q.level ? ('Level: '+q.level) : '';
  document.getElementById('opts').innerHTML = '';
  document.getElementById('fillArea').style.display = 'none';
  document.getElementById('status').textContent = 'C√¢u h·ªèi m·ªü ‚Äî ch·ªçn ƒë√°p √°n';
  document.getElementById('timeLeft').textContent = cur.timeLeft !== undefined ? cur.timeLeft : (q.time||30);

  if(q.type === 'fill'){
    document.getElementById('fillArea').style.display = 'block';
    document.getElementById('opts').style.display = 'none';
    document.getElementById('fillSubmit').onclick = async ()=>{
      const v = document.getElementById('fillInput').value.trim();
      if(v==='') return;
      await submitAnswer(v);
    };
  } else {
    document.getElementById('opts').style.display = 'grid';
    const colors = ['c-red','c-blue','c-yellow','c-green'];
    (q.options||[]).forEach((o,i)=>{
      const b = document.createElement('div'); b.className = 'optBtn '+colors[i%colors.length];
      b.textContent = String.fromCharCode(65+i) + '. ' + o;
      b.onclick = ()=> submitAnswer(i);
      document.getElementById('opts').appendChild(b);
    });
    document.getElementById('fillArea').style.display = 'none';
  }
}

/* Hide question after answer */
function hideQuestion(){
  document.getElementById('opts').innerHTML = '';
  document.getElementById('fillArea').style.display = 'none';
}

/* Submit answer */
async function submitAnswer(ans){
  if(!joined || !roomId) return;
  const now = Date.now();
  await db.ref('rooms/'+roomId+'/current/answers/'+playerId).set({
    name: playerName,
    answer: ans,
    time: now
  });
  document.getElementById('status').textContent = 'ƒê√£ g·ª≠i ƒë√°p √°n ‚Äî ch·ªù k·∫øt qu·∫£...';
  hideQuestion();
}

/* Listen scores & ranking */
function listenScoresAndRanking(){
  db.ref('rooms/'+roomId+'/scores/'+playerId).on('value', snap=>{
    const s = snap.val() || 0;
    document.getElementById('myScore').textContent = s;
  });
  db.ref('rooms/'+roomId+'/ranking').on('value', snap=>{
    const rankArr = snap.val() || [];
    // display top3
    const top3Div = document.getElementById('top3'); top3Div.innerHTML = '';
    let myRank = '-';
    for(let i=0;i<rankArr.length;i++){
      const r = rankArr[i];
      const pid = r.pid || r[0];
      const sc = r.score || r[1];
      const name = pid;
      if(i<3){
        top3Div.innerHTML += `<div>${i+1}. ${name} ‚Äî ${sc} pts</div>`;
      }
      if(pid === playerId) myRank = i+1;
    }
    document.getElementById('myRank').textContent = myRank;
    document.getElementById('medal').textContent = myRank === 1 ? ' ü•á' : (myRank === 2 ? ' ü•à' : (myRank === 3 ? ' ü•â' : ''));
  });
}
</script>
</body>
</html>
