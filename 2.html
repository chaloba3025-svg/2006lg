<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kahoot-like — Student</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1020;color:#fff}
  .wrap{max-width:720px;margin:18px auto;padding:12px}
  .card{background:#1e293b;padding:18px;border-radius:14px}
  input,button{padding:12px;border-radius:10px;border:none;font-size:15px}
  button{background:#2563eb;color:#fff;cursor:pointer}
  .timer{font-weight:800;font-size:24px;margin-bottom:10px;color:#fef08a;transition:.3s}
  .question{font-size:20px;font-weight:800;margin-bottom:14px;text-align:center}
  .opts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .opt{padding:30px;border-radius:14px;font-weight:800;text-align:center;cursor:pointer;transition:.2s;user-select:none}
  .opt:hover{transform:scale(1.05)}
  .red{background:#e63946}.blue{background:#2a9df4}.yellow{background:#f4b400;color:#111}.green{background:#2ec4b6}
  .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:36px;font-weight:800;animation:pop 1s ease-out forwards;pointer-events:none}
  @keyframes pop{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(.5)}}
  .status{margin-bottom:8px;font-weight:700}
  .correct{outline:4px solid #10b981}
  .wrong{opacity:.4}
  .muted{opacity:.5}
  .input-answer{display:flex;gap:8px}
  .input-answer input{flex:1;padding:8px;border-radius:8px;border:none;font-size:16px}
  .personal-box{margin-top:12px;text-align:center;display:none}
  .big-score{font-size:28px;font-weight:900;color:#fef08a}
  .big-rank{font-size:36px;font-weight:900;color:#34d399}
  .highlight-name{font-weight:800;font-size:18px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="joinCard">
    <input id="nameInput" placeholder="Tên của bạn" style="width:100%;margin-bottom:8px"/>
    <input id="roomInput" placeholder="Mã phòng" style="width:100%;margin-bottom:8px"/>
    <button id="joinBtn">Join</button>
  </div>

  <div class="card" id="playCard" style="display:none;margin-top:14px">
    <div class="status" id="statusText">⏳ Đang chờ giáo viên bắt đầu…</div>
    <div class="timer">⏳ <span id="timeLeft">0</span>s</div>
    <div class="question" id="qText">Chờ...</div>
    <div id="opts" class="opts"></div>

    <!-- personal info big panel shown after each question closed -->
    <div class="personal-box" id="personalBox">
      <div id="personalName" class="highlight-name"></div>
      <div>Điểm của bạn: <span id="myScore">0</span></div>
      <div>Hạng của bạn:</div>
      <div id="myRank" class="big-rank">-</div>
    </div>
  </div>
</div>

<!-- Sounds -->
<audio id="clickSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="correctSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="wrongSound" src="https://actions.google.com/sounds/v1/cartoon/metal_thud_and_clang.ogg"></audio>
<audio id="bgMusic" src="https://actions.google.com/sounds/v1/ambiences/office.ogg" loop></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyBMIxJxZ4GC8HTTKREB45SRSbTay15Kg7I",
authDomain:"kahoot-like-5251e.firebaseapp.com",
databaseURL:"https://kahoot-like-5251e-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"kahoot-like-5251e",storageBucket:"kahoot-like-5251e.appspot.com",
messagingSenderId:"805207333072",appId:"1:805207333072:web:63d23d41b05fa6bd71e6d5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let roomId=null,playerId="p"+Math.floor(Math.random()*1e6),playerName="";
let currentQ_ts=null;
let localShuffle=[]; // localIdx -> originalIdx
let hasAnswered=false;

document.getElementById("joinBtn").onclick=async()=>{
  playerName=document.getElementById("nameInput").value.trim();
  roomId=document.getElementById("roomInput").value.trim();
  if(!playerName||!roomId) return;
  await db.ref("rooms/"+roomId+"/players/"+playerId).set({name:playerName});
  document.getElementById("joinCard").style.display="none";
  document.getElementById("playCard").style.display="block";
  document.getElementById("personalName").textContent = playerName;
  listenRoom();
  listenRank();
};

// helpers
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
function setStatus(txt){ document.getElementById("statusText").textContent = txt; }

// listen current question
function listenRoom(){
  db.ref("rooms/"+roomId+"/current").on("value", snap=>{
    const cur = snap.val();
    if(!cur){
      setStatus("Phòng không tồn tại hoặc đã kết thúc.");
      document.getElementById("opts").innerHTML="";
      try{document.getElementById("bgMusic").pause();}catch(e){}
      return;
    }

    // update timer if provided
    if(cur.timeLeft !== undefined) document.getElementById("timeLeft").textContent = cur.timeLeft;

    // new question detection by startAt
    const qObj = cur.q || null;
    if(qObj && qObj.startAt && qObj.startAt !== currentQ_ts){
      currentQ_ts = qObj.startAt;
      renderQuestion(qObj);
      hasAnswered = Boolean(cur.answers && cur.answers[playerId]);
      setStatus(hasAnswered ? "⏳ Bạn đã trả lời" : "⏳ Trả lời ngay!");
      try{document.getElementById("bgMusic").play();}catch(e){}
    }

    // when closed -> show personal big panel + popup correct/incorrect via scores diff
    if(cur.status === "closed"){
      // stop bg music
      try{document.getElementById("bgMusic").pause();document.getElementById("bgMusic").currentTime=0;}catch(e){}
      // show personal box (my score & rank are updated via listeners)
      document.getElementById("personalBox").style.display = "block";
      setStatus("Câu đã kết thúc");
      // display popup correct/incorrect (we infer by comparing previous score via score listener)
      // (score listener already shows popup on increment)
    }
  });

  // room removal
  db.ref("rooms/"+roomId).on("value", snap=>{
    if(!snap.val()){
      setStatus("Phòng đã được xoá (Game kết thúc).");
      document.getElementById("opts").innerHTML = "";
      try{document.getElementById("bgMusic").pause();}catch(e){}
    }
  });
}

// render question (NEW: local shuffle per student; input fixed & focused)
function renderQuestion(q){
  document.getElementById("qText").textContent = q.text;
  const box = document.getElementById("opts"); box.innerHTML = "";
  hasAnswered = false;
  document.getElementById("personalBox").style.display = "none";

  if(q.type === "input"){
    const wrapper = document.createElement("div"); wrapper.className = "input-answer";
    const inp = document.createElement("input");
    inp.type = "text";
    inp.placeholder = "Nhập đáp án (vd: pi/6 hoặc can(2) hoặc khong xac dinh)";
    inp.autocomplete = "off";
    inp.autocapitalize = "off";
    inp.spellcheck = false;
    inp.style.fontSize = "16px";
    const btn = document.createElement("button"); btn.textContent = "Submit";
    // ensure input accepts typing on desktop: focus programmatically (NEW)
    setTimeout(()=>{ try{ inp.focus(); }catch(e){} }, 100);
    btn.onclick = ()=>{ submitInput(inp.value); };
    wrapper.appendChild(inp); wrapper.appendChild(btn); box.appendChild(wrapper);
  } else {
    // MC: local shuffle (NEW)
    const orig = q.options || [];
    const idxs = orig.map((_,i)=>i);
    shuffleArray(idxs);
    localShuffle = idxs.slice(); // localIdx -> originalIdx
    const colors = ["red","blue","yellow","green"];
    for(let k=0;k<idxs.length;k++){
      const origIdx = idxs[k];
      const d = document.createElement("div");
      d.className = "opt " + colors[k%4];
      d.textContent = String.fromCharCode(65+k) + ". " + orig[origIdx];
      (function(localIndex, originalIndex){
        d.onclick = ()=>{ submitAnswer(originalIndex, localIndex); };
      })(k, origIdx);
      box.appendChild(d);
    }
  }
}

// submit MC (send original index) (NEW)
async function submitAnswer(originalIndex, localIndex){
  if(hasAnswered) return;
  try{document.getElementById("clickSound").play();}catch(e){}
  const now = Date.now();
  const timeLeft = Number(document.getElementById("timeLeft").textContent) || 0;
  await db.ref("rooms/"+roomId+"/current/answers/"+playerId).set({ name: playerName, answer: originalIndex, time: now, remaining: timeLeft });
  hasAnswered = true;
  lockUIAfterAnswer(localIndex);
}

// submit input (NEW)
async function submitInput(text){
  if(hasAnswered) return;
  const val = String(text||"").trim();
  if(!val) return;
  const now = Date.now();
  const timeLeft = Number(document.getElementById("timeLeft").textContent) || 0;
  // accept pi and can(2) as instructed
  await db.ref("rooms/"+roomId+"/current/answers/"+playerId).set({ name: playerName, answer: val, time: now, remaining: timeLeft });
  hasAnswered = true;
  lockUIAfterAnswer(null);
}

// lock UI locally after answering
function lockUIAfterAnswer(localIndex){
  const box = document.getElementById("opts");
  Array.from(box.children).forEach((el,i)=>{
    el.classList.add("muted");
    el.onclick = null;
  });
  const notice = document.createElement("div"); notice.style.marginTop="8px"; notice.textContent="Bạn đã trả lời ✅";
  box.appendChild(notice);
  try{document.getElementById("clickSound").play();}catch(e){}
}

// personal score + rank listeners (show big panel & popup on increase)
function listenRank(){
  db.ref("rooms/"+roomId+"/scores/"+playerId).on("value", s=>{
    const old = Number(document.getElementById("myScore").textContent) || 0;
    const val = s.val() || 0;
    document.getElementById("myScore").textContent = val;
    if(val > old){
      const diff = val - old;
      showPopup("+" + diff);
      try{document.getElementById("correctSound").play();}catch(e){}
    }
  });

  db.ref("rooms/"+roomId+"/ranking").on("value", snap=>{
    const arr = snap.val() || [];
    let rank = "-";
    arr.forEach((r,i)=>{ if(r.pid === playerId) rank = i+1; });
    document.getElementById("myRank").textContent = rank;
    // show big personal panel
    document.getElementById("personalBox").style.display = "block";
  });
}

// popup helper
function showPopup(txt){
  const p = document.createElement("div"); p.className="popup"; p.textContent = txt;
  document.body.appendChild(p); setTimeout(()=>p.remove(),1000);
}
</script>
</body>
</html>
